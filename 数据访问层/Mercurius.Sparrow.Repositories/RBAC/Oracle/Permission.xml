<?xml version="1.0" encoding="utf-8" ?>
<sqlMap namespace="Mercurius.Siskin.Repositories.RBAC.Permission" xmlns="http://ibatis.apache.org/mapping">
  <alias>
    <typeAlias alias="SystemMenu" type="Mercurius.Siskin.Entities.RBAC.SystemMenu, Mercurius.Siskin.Entities" />
  </alias>

  <statements>

    <!-- 获取系统菜单 -->
    <select id="GetSystemMenus" parameterClass="string" resultClass="SystemMenu">
      <![CDATA[
        SELECT 
          Id                                                             AS "Id"
          ,Name                                                          AS "Name"
          ,Title                                                         AS "Title"
          ,Image                                                         AS "Image"
          ,Category                                                      AS "Category"
          ,Target                                                        AS "Target"
          ,ParentId                                                      AS "ParentId"
          ,CAST(Category AS VARCHAR(10))||'-'||CAST(Sort AS VARCHAR(10)) AS "FullSort"
          ,NavigateUrl                                                   AS "NavigateUrl"
          ,CreateUserName                                                AS "CreateUserName"
          ,CreateDateTime                                                AS "CreateDateTime"
          ,ModifyUserName                                                AS "ModifyUserName"
          ,ModifyDateTime                                                AS "ModifyDateTime"
          ,(
            SELECT
              COUNT(1)
            FROM dual 
            WHERE EXISTS
            (
              SELECT
                *
              FROM RBAC.systemmenu b 
              WHERE b.parentId=a.id AND Category=3 AND Status=1
            )
          )                                                              AS "ExistsButton"
        FROM RBAC.SystemMenu a
        WHERE Status=1 AND Category!=3
        ORDER BY Sort ASC
      ]]>
    </select>

    <!-- 获取菜单的按钮 -->
    <select id="GetSystemMenuButtons" parameterClass="string" resultClass="SystemMenu">
      <![CDATA[
        SELECT 
          Id                                                             AS "Id"
          ,Name                                                          AS "Name"
          ,Title                                                         AS "Title"
          ,Image                                                         AS "Image"
          ,Category                                                      AS "Category"
          ,Target                                                        AS "Target"
          ,ParentId                                                      AS "ParentId"
          ,CAST(Category AS VARCHAR(10))||'-'||CAST(Sort AS VARCHAR(10)) AS "FullSort"
          ,NavigateUrl                                                   AS "NavigateUrl"
          ,CreateUserName                                                AS "CreateUserName"
          ,CreateDateTime                                                AS "CreateDateTime"
          ,ModifyUserName                                                AS "ModifyUserName"
          ,ModifyDateTime                                                AS "ModifyDateTime"
        FROM RBAC.SystemMenu 
        WHERE ParentId=#value# AND Category=3 AND Status=1
      ]]>
    </select>

    <!-- 获取新增按钮菜单的排序号 -->
    <select id="NewSystemMenuButtonSort" parameterClass="string" resultClass="int">
      <![CDATA[
        SELECT 
          CASE
		        WHEN MAX(SORT) IS NULL THEN 1
			      ELSE MAX(SORT)+1 
	        END CASE
        FROM RBAC.systemmenu
        WHERE ParentId=#value# AND CATEGORY=3 AND Status=1
      ]]>
    </select>

    <!-- 检查菜单相关联的按钮是否已经添加 -->
    <select id="CheckSystemButtonExists" parameterClass="Params" resultClass="int">
      <![CDATA[
        SELECT 
          COUNT(1) AS COUNT
        FROM dual
        WHERE EXISTS (
          SELECT * FROM RBAC.SystemMenu
          WHERE ParentId=#ParentId# AND NAME=#ButtonName# AND CATEGORY=3 AND Status=1
        )
      ]]>
    </select>

    <!-- 根据用户编号获取标有访问权限的菜单列表 -->
    <select id="GetSystemMenusWithAlloted" parameterClass="string" resultClass="SystemMenu">
      <![CDATA[
        WITH CTE AS
        (
          SELECT 
             DISTINCT(M.Id)
	        FROM 
	        (
            SELECT
              M.Id,
              '角色权限' AS TheirTYPE
            FROM RBAC.SystemMenu M
            LEFT JOIN RBAC.RolePermission R_R 
              ON R_R.SystemMenuId = M.Id
            LEFT JOIN RBAC.UserRole U_R 
              ON U_R.RoleId = R_R.RoleId
            WHERE U_R.UserId=#value# 
            UNION ALL
            SELECT 
              M.Id,
              '用户组权限' AS TheirTYPE 
            FROM RBAC.SystemMenu M
            LEFT JOIN  RBAC.UserGroupPermission U_R 
              ON U_R.SystemMenuId = M.Id
            LEFT JOIN RBAC.UserGroupRelation U_G 
              ON U_G.UserGroupId = U_R.UserGroupId
            WHERE U_G.UserId = #value#
            UNION ALL
            SELECT 
              M.Id,
              '用户权限' AS TheirTYPE 
            FROM RBAC.SystemMenu M
            LEFT JOIN  RBAC.UserPermission U_R 
              ON U_R.SystemMenuId = M.Id
            WHERE U_R.UserId = #value#
          ) M
        )
        SELECT
           s.Id                                                           AS "Id"
           ,CASE WHEN CTE.ID IS NOT NULL THEN 1 ELSE 0 END                AS "CanAccess"
           ,Name                                                          AS "Name"
           ,Title                                                         AS "Title"
           ,Image                                                         AS "Image"
           ,Category                                                      AS "Category"
           ,Target                                                        AS "Target"
           ,ParentId                                                      AS "ParentId"
           ,CAST(Category AS VARCHAR(10))||'-'||CAST(Sort AS VARCHAR(10)) AS "FullSort"
           ,NavigateUrl                                                   AS "NavigateUrl"
           ,CreateUserName                                                AS "CreateUserName"
           ,CreateDateTime                                                AS "CreateDateTime"
           ,ModifyUserName                                                AS "ModifyUserName"
           ,ModifyDateTime                                                AS "ModifyDateTime"
        FROM RBAC.SystemMenu s
        LEFT OUTER JOIN CTE
          ON s.id=cte.id
        WHERE s.Status=1
      ]]>
    </select>

    <!-- 获取标有用户拥有访问权限的菜单列表 -->
    <select id="GetSystemMenusWithAllotedByUser" parameterClass="string" resultClass="SystemMenu">
      <![CDATA[
        WITH CTE AS
        (
          SELECT
            Distinct M.Id
          FROM RBAC.SystemMenu M
          LEFT JOIN RBAC.UserPermission U_P 
            ON U_P.SystemMenuId = M.Id
          WHERE U_P.UserId=#value#
        )
        SELECT
          s.Id                                                           AS "Id"
          ,CASE WHEN CTE.ID IS NOT NULL THEN 1 ELSE 0 END                AS "CanAccess"
          ,Name                                                          AS "Name"
          ,Title                                                         AS "Title"
          ,Image                                                         AS "Image"
          ,Category                                                      AS "Category"
          ,Target                                                        AS "Target"
          ,ParentId                                                      AS "ParentId"
          ,CAST(Category AS VARCHAR(10))||'-'||CAST(Sort AS VARCHAR(10)) AS "FullSort"
          ,NavigateUrl                                                   AS "NavigateUrl"
          ,CreateUserName                                                AS "CreateUserName"
          ,CreateDateTime                                                AS "CreateDateTime"
          ,ModifyUserName                                                AS "ModifyUserName"
          ,ModifyDateTime                                                AS "ModifyDateTime"
        FROM RBAC.SystemMenu s
        LEFT OUTER JOIN CTE
          ON s.id=cte.id
        WHERE s.Status=1
      ]]>
    </select>

    <!-- 获取标有角色拥有访问权限的菜单列表 -->
    <select id="GetSystemMenusWithAllotedByRole" parameterClass="string" resultClass="SystemMenu">
      <![CDATA[
        WITH CTE AS
        (
          SELECT
            Distinct M.Id
          FROM RBAC.SystemMenu M
          LEFT JOIN RBAC.RolePermission R_R 
            ON R_R.SystemMenuId = M.Id
          WHERE R_R.RoleId=#value#
        )
        SELECT
          s.Id                                                           AS "Id"
          ,CASE WHEN CTE.ID IS NOT NULL THEN 1 ELSE 0 END                AS "CanAccess"
          ,Name                                                          AS "Name"
          ,Title                                                         AS "Title"
          ,Image                                                         AS "Image"
          ,Category                                                      AS "Category"
          ,Target                                                        AS "Target"
          ,ParentId                                                      AS "ParentId"
          ,CAST(Category AS VARCHAR(10))||'-'||CAST(Sort AS VARCHAR(10)) AS "FullSort"
          ,NavigateUrl                                                   AS "NavigateUrl"
          ,CreateUserName                                                AS "CreateUserName"
          ,CreateDateTime                                                AS "CreateDateTime"
          ,ModifyUserName                                                AS "ModifyUserName"
          ,ModifyDateTime                                                AS "ModifyDateTime"
        FROM RBAC.SystemMenu s
        LEFT OUTER JOIN CTE
          ON s.id=cte.id
        WHERE s.Status=1
      ]]>
    </select>

    <!-- 获取标有用户组拥有访问权限的菜单列表 -->
    <select id="GetSystemMenusWithAllotedByUserGroup" parameterClass="string" resultClass="SystemMenu">
      <![CDATA[
        WITH CTE AS
        (
          SELECT
            Distinct M.Id
          FROM RBAC.SystemMenu M
          LEFT JOIN RBAC.UserGroupPermission U_G
            ON U_G.SystemMenuId = M.Id
          WHERE U_G.UserGroupId=#value#
        )
        SELECT
          s.Id                                                           AS "Id"
          ,CASE WHEN CTE.ID IS NOT NULL THEN 1 ELSE 0 END                AS "CanAccess"
          ,Name                                                          AS "Name"
          ,Title                                                         AS "Title"
          ,Image                                                         AS "Image"
          ,Category                                                      AS "Category"
          ,Target                                                        AS "Target"
          ,ParentId                                                      AS "ParentId"
          ,CAST(Category AS VARCHAR(10))||'-'||CAST(Sort AS VARCHAR(10)) AS "FullSort"
          ,NavigateUrl                                                   AS "NavigateUrl"
          ,CreateUserName                                                AS "CreateUserName"
          ,CreateDateTime                                                AS "CreateDateTime"
          ,ModifyUserName                                                AS "ModifyUserName"
          ,ModifyDateTime                                                AS "ModifyDateTime"
        FROM RBAC.SystemMenu s
        LEFT OUTER JOIN CTE
          ON s.id=cte.id
        WHERE s.Status=1
      ]]>
    </select>

    <!-- 获取用户可访问的菜单 -->
    <select id="GetAccessibleMenusByUser" parameterClass="string" resultClass="SystemMenu">
      <![CDATA[
        SELECT
          M.Id           AS "Id"
          ,M.Name        AS "Name"
          ,M.Title       AS "Title"
          ,M.Image       AS "Image"
          ,M.Target      AS "Target"
          ,M.ParentId    AS "ParentId"
          ,M.NavigateUrl AS "NavigateUrl"
          ,M.Sort        AS "Sort"
        FROM
        (
          SELECT
            M.Name,
            M.Title,
            M.Image,
            M.Target,
            M.ParentId,
            M.Id,
            M.NavigateUrl,
            M.Sort,
            '角色权限' AS TheirTYPE
          FROM RBAC.SystemMenu M
          LEFT JOIN RBAC.RolePermission R_R 
            ON R_R.SystemMenuId=M.Id
          LEFT JOIN RBAC.UserRole U_R 
            ON U_R.RoleId=R_R.RoleId
          WHERE M.Target='Iframe' AND U_R.UserId=#value# AND M.Status=1
          UNION ALL
          SELECT
            M.Name,
            M.Title,
            M.Image,
            M.Target,
            M.ParentId,
            M.Id,
            M.NavigateUrl,
            M.Sort,
            '用户组权限' AS TheirTYPE
          FROM RBAC.SystemMenu M
          LEFT JOIN RBAC.UserGroupPermission U_R 
            ON U_R.SystemMenuId=M.Id
          LEFT JOIN RBAC.UserGroupRelation U_G 
            ON U_G.UserGroupId=U_R.UserGroupId
          WHERE M.Target='Iframe' AND U_G.UserId = #value# AND M.Status = 1
          UNION ALL
          SELECT
            M.Name,
            M.Title,
            M.Image,
            M.Target,
            M.ParentId,
            M.Id,
            M.NavigateUrl,
            M.Sort,
            '用户权限' AS TheirTYPE
          FROM RBAC.SystemMenu M
          LEFT JOIN RBAC.UserPermission U_R 
            ON U_R.SystemMenuId=M.Id
          WHERE M.Target='Iframe' AND U_R.UserId = #value# AND M.Status=1
         ) M
        GROUP BY M.Id, M.Name, M.Title, M.Image,
          M.Target, M.ParentId, M.NavigateUrl, M.Sort 
        ORDER BY M.Sort
      ]]>
    </select>

    <!-- 获取用户当前可以使用的按钮 -->
    <select id="GetAccessibleButtons" parameterClass="Params" resultClass="SystemMenu">
      <![CDATA[
        WITH cte AS
        (
          SELECT  
            M.Id,
            M.Name,
            M.Title,
            M.Image,
            M.Target,
            M.ParentId,
            M.NavigateUrl,
            M.Sort,
            M.Category
          FROM
          (
            SELECT
              M.Name,
              M.Title,
              M.Image,
              M.Target,
              M.ParentId,
              M.Id,
              M.NavigateUrl,
              M.Sort,
              M.Category,
              '角色权限' AS TheirTYPE
            FROM RBAC.SystemMenu M
            LEFT JOIN RBAC.RolePermission R_R 
              ON R_R.SystemMenuId=M.Id
            LEFT JOIN RBAC.UserRole U_R 
              ON U_R.RoleId=R_R.RoleId
            WHERE U_R.UserId=#UserId# AND M.Status=1
            UNION ALL
            SELECT
              M.Name,
              M.Title,
              M.Image,
              M.Target,
              M.ParentId,
              M.Id,
              M.NavigateUrl,
              M.Sort,
              M.Category,
              '用户组权限' AS TheirTYPE
            FROM RBAC.SystemMenu M
            LEFT JOIN RBAC.UserGroupPermission U_R 
              ON U_R.SystemMenuId=M.Id
            LEFT JOIN RBAC.UserGroupRelation U_G 
              ON U_G.UserGroupId=U_R.UserGroupId
            WHERE U_G.UserId=#UserId# AND M.Status=1
            UNION ALL
            SELECT
              M.Name,
              M.Title,
              M.Image,
              M.Target,
              M.ParentId,
              M.Id,
              M.NavigateUrl,
              M.Sort,
              M.Category,
              '用户权限' AS TheirTYPE
            FROM RBAC.SystemMenu M
            LEFT JOIN RBAC.UserPermission U_R 
              ON U_R.SystemMenuId=M.Id
            WHERE U_R.UserId=#UserId# AND M.Status=1
          ) M
          GROUP BY M.Id, M.Name, M.Title, M.Image,
            M.Target, M.ParentId, M.NavigateUrl, M.Sort,M.Category
        )
        SELECT
          Id           AS "Id"
          ,Name        AS "Name"
          ,Title       AS "Title"
          ,Image       AS "Image"
          ,Target      AS "Target"
          ,ParentId    AS "ParentId"
          ,NavigateUrl AS "NavigateUrl"
          ,Category    AS "Category"
          ,Sort        AS "Sort"
        FROM cte
        WHERE ParentId IN (SELECT Id FROM cte WHERE NavigateUrl=#NavigateUrl#) AND cte.Category=3
        ORDER BY Sort
      ]]>
    </select>

    <!-- 获取菜单项 -->
    <select id="GetSystemMenu" parameterClass="string" resultClass="SystemMenu">
      <![CDATA[
        SELECT 
          Id              AS "Id"
          ,Name           AS "Name"
          ,Title          AS "Title"
          ,Image          AS "Image"
          ,Category       AS "Category"
          ,Target         AS "Target"
          ,ParentId       AS "ParentId"
          ,Sort           AS "Sort"
          ,NavigateUrl    AS "NavigateUrl"
          ,CreateUserName AS "CreateUserName"
          ,CreateDateTime AS "CreateDateTime"
          ,ModifyUserName AS "ModifyUserName"
          ,ModifyDateTime AS "ModifyDateTime"
        FROM RBAC.SystemMenu 
        WHERE Id=#value#
      ]]>
    </select>

    <!-- 添加或编辑系统菜单信息 -->
    <insert id="CreateOrUpdateSystemMenu" parameterClass="SystemMenu">
      <![CDATA[
        MERGE INTO RBAC.SystemMenu his
        USING (SELECT * FROM RBAC.SystemMenu WHERE Id=#Id#) src
        ON (his.Id=src.Id)
        WHEN MATCHED THEN
          UPDATE SET
            his.ParentId=#ParentId#,
            his.Name=#Name#,
            his.Title=#Title#,
            his.Image=#Image#,
            his.Category=#Category#,
            his.NavigateUrl=#NavigateUrl#,
            his.Target=#Target#,
            his.Sort=#Sort#,
            his.ModifyDateTime=#ModifyDateTime#,
            his.ModifyUserId=#ModifyUserId#,
            his.ModifyUserName=#ModifyUserName#
        WHEN NOT MATCHED THEN 
          INSERT
  		    ( 
            his.Id,
  		      his.ParentId,
  		      his.Name,
  		      his.Title,
  		      his.Image,
  		      his.Category,
  		      his.NavigateUrl,
  		      his.Target,
  		      his.Sort,
            his.Status,
  		      his.CreateDateTime,
  		      his.CreateUserId,
  		      his.CreateUserName
  		    )
          VALUES
          (
            #Id#,
  		      #ParentId#,
  		      #Name#,
  		      #Title#,
  		      #Image#,
  		      #Category#,
  		      #NavigateUrl#,
  		      #Target#,
  		      #Sort#,
            1,
  		      #CreateDateTime#,
  		      #CreateUserId#,
  		      #CreateUserName#
  		    )
      ]]>
    </insert>

    <!-- 分配角色权限 -->
    <insert id="AllotPermissionByRole" parameterClass="Params">
      <![CDATA[
        BEGIN
          DELETE FROM RBAC.RolePermission WHERE RoleId=#RoleId#;
      ]]>
      <dynamic>
        <iterate property="RolePermissions" open="" close=";" conjunction=";">
          <![CDATA[
            INSERT INTO RBAC.RolePermission
            (
              Id,
              RoleId,
              SystemMenuId,
              CreateDateTime,
              CreateUserId,
              CreateUserName
            )
            VALUES
            (
              #RolePermissions[].Id#,
              #RolePermissions[].RoleId#,
              #RolePermissions[].SystemMenuId#,
              #RolePermissions[].CreateDateTime#,
              #RolePermissions[].CreateUserId#,
              #RolePermissions[].CreateUserName#
            )
          ]]>
        </iterate>
      </dynamic>
      <![CDATA[
        END;
      ]]>
    </insert>

    <!-- 分配用户权限 -->
    <insert id="AllotPermissionByUser" parameterClass="Params">
      <![CDATA[
        BEGIN
          DELETE FROM RBAC.USERPERMISSION WHERE UserId=#UserId#;
      ]]>
      <dynamic>
        <isNotNull property="UserPermissions">
          <iterate property="UserPermissions" open="" close=";" conjunction=";">
            <![CDATA[
              INSERT INTO RBAC.USERPERMISSION
              (
                Id,
                UserId,
                SystemMenuId,
                CreateDateTime,
                CreateUserId,
                CreateUserName
              )
              VALUES
              (
                #UserPermissions[].Id#,
                #UserPermissions[].UserId#,
                #UserPermissions[].SystemMenuId#,
                #UserPermissions[].CreateDateTime#,
                #UserPermissions[].CreateUserId#,
                #UserPermissions[].CreateUserName#
              )
            ]]>
          </iterate>
        </isNotNull>
      </dynamic>
      <![CDATA[
        END;
      ]]>
    </insert>

    <insert id="AllotPermissionByUserGroup" parameterClass="Params">
      <![CDATA[
        BEGIN
          DELETE FROM RBAC.UserGroupPermission WHERE UserGroupId=#UserGroupId#;
      ]]>
      <dynamic>
        <isNotNull property="UserGroupPermissions">
          <iterate property="UserGroupPermissions" open="" close=";" conjunction=";">
            <![CDATA[
              INSERT INTO RBAC.UserGroupPermission
              (
                Id,
                UserGroupId,
                SystemMenuId,
                CreateDateTime,
                CreateUserId,
                CreateUserName
              )
              VALUES
              (
                #UserGroupPermissions[].Id#,
                #UserGroupPermissions[].UserGroupId#,
                #UserGroupPermissions[].SystemMenuId#,
                #UserGroupPermissions[].CreateDateTime#,
                #UserGroupPermissions[].CreateUserId#,
                #UserGroupPermissions[].CreateUserName#
              )
            ]]>
          </iterate>
        </isNotNull>
      </dynamic>
      <![CDATA[
        END;
      ]]>
    </insert>

    <!-- 删除系统菜单信息 -->
    <delete id="DeleteSystemMenu" parameterClass="string">
      <![CDATA[
        DELETE FROM RBAC.SystemMenu WHERE Id=#value#
      ]]>
    </delete>
  </statements>
</sqlMap>