<?xml version="1.0" encoding="utf-8" ?>
<sqlMap namespace="Mercurius.Sparrow.Repositories.RBAC.Recyclebin" xmlns="http://ibatis.apache.org/mapping">
  <alias>
    <typeAlias alias="Recyclebin" type="Mercurius.Sparrow.Entities.RBAC.Recyclebin, Mercurius.Sparrow.Entities" />
    <typeAlias alias="RecyclebinSO" type="Mercurius.Sparrow.Entities.RBAC.SO.RecyclebinSO, Mercurius.Sparrow.Entities"/>
  </alias>

  <statements>

    <!-- 获取回收站信息分类 -->
    <select id="GetCategories" parameterClass="string" resultClass="string">
      <![CDATA[
        SELECT DISTINCT(Category) FROM RBAC.Recyclebin WHERE CreateUserId=#value#
      ]]>
    </select>

    <!-- 获取回收站所有信息 -->
    <select id="GetRecyclebins" parameterClass="RecyclebinSO" resultClass="Recyclebin">
      <![CDATA[
        WITH cte AS(
          SELECT
            Id              AS "Id"
            ,Category       AS "Category"
            ,DatabaseName   AS "Database"
            ,TableName      AS "Table"
            ,ColumnName     AS "Column"
            ,Value          AS "Value"
            ,Remark         AS "Remark"
            ,CreateDateTime AS "CreateDateTime"
            ,CreateUserId   AS "CreateUserId"
            ,CreateUserName AS "CreateUserName"
          FROM RBAC.Recyclebin
          WHERE CreateUserId=#UserId#
      ]]>
      <dynamic>
        <isNotNull property="Category">
          <isNotEmpty property="Category" prepend="AND">
            Category=#Category#
          </isNotEmpty>
        </isNotNull>
        <isNotNull property="StartDate" prepend="AND">
          CreateDateTime>=#StartDate#
        </isNotNull>
        <isNotNull property="EndDate" prepend="AND">
          <![CDATA[
              CreateDateTime<=#EndDate#
            ]]>
        </isNotNull>
      </dynamic>
      <![CDATA[
        ),
        paging AS(
          SELECT
            ROWNUM AS "RowIndex",
            cte.*
          FROM cte
        )
        SELECT
          paging.*
        FROM paging
        WHERE "RowIndex" BETWEEN (#PageIndex#-1)*#PageSize#+1 AND #PageIndex#*#PageSize#
      ]]>
    </select>

    <select id="GetRecyclebinsCount" parameterClass="RecyclebinSO" resultClass="int">
      <![CDATA[
        SELECT
          Count(*)
        FROM RBAC.Recyclebin
        WHERE CreateUserId=#UserId#
      ]]>
      <dynamic>
        <isNotNull property="Category">
          <isNotEmpty property="Category" prepend="AND">
            Category=#Category#
          </isNotEmpty>
        </isNotNull>
        <isNotNull property="StartDate" prepend="AND">
          CreateDateTime>=#StartDate#
        </isNotNull>
        <isNotNull property="EndDate" prepend="AND">
          <![CDATA[
              CreateDateTime<=#EndDate#
            ]]>
        </isNotNull>
      </dynamic>
    </select>

    <!-- 获取回收站信息 -->
    <select id="GetRecyclebinById" parameterClass="string" resultClass="Recyclebin">
      <![CDATA[
        SELECT
          Id              AS "Id"
          ,Category       AS "Category"
          ,DatabaseName   AS "Database"
          ,TableName      AS "Table"
          ,ColumnName     AS "Column"
          ,Value          AS "Value"
          ,Remark         AS "Remark"
          ,CreateDateTime AS "CreateDateTime"
          ,CreateUserId   AS "CreateUserId"
          ,CreateUserName AS "CreateUserName"
        FROM RBAC.Recyclebin
        WHERE Id=#value#
      ]]>
    </select>

    <!-- 获取回收站信息详情 -->
    <select id="GetRecyclebinDetails" parameterClass="Params" resultClass="DataTable">
      <![CDATA[
        SELECT * FROM $Table$ WHERE $Column$=#Value#
      ]]>
    </select>

    <!-- 删除数据 -->
    <delete id="Remove" parameterClass="Params">
      <![CDATA[
        DELETE FROM $Table$ WHERE $Column$ IN
      ]]>
      <iterate property="Values" open="(" close=")" conjunction=",">
        #Values[]#
      </iterate>
    </delete>

    <!-- 虚拟删除数据(将表中Status字段值置为0) -->
    <delete id="VirtualRemove" parameterClass="Params">
      <![CDATA[
        BEGIN
          UPDATE $Table$
          SET
            Status=0
          WHERE $Column$ IN
      ]]>
      <iterate property="Recyclebins" open="(" close=");" conjunction=",">
        #Recyclebins[].Value#
      </iterate>
      <iterate property="Recyclebins" open="" close=";" conjunction=";">
        <![CDATA[
          INSERT INTO RBAC.Recyclebin
		      (
            Id,
		        Category,
		        DatabaseName,
		        TableName,
		        ColumnName,
		        Value,
		        CreateDateTime,
		        CreateUserId,
		        CreateUserName
		      )
          VALUES
          ( 
            #Recyclebins[].Id#,
		        #Recyclebins[].Category#,
		        #Recyclebins[].Database#,
		        #Recyclebins[].Table#,
		        #Recyclebins[].Column#,
		        #Recyclebins[].Value#,
		        #Recyclebins[].CreateDateTime#,
		        #Recyclebins[].CreateUserId#,
		        #Recyclebins[].CreateUserName#
		      )
        ]]>
      </iterate>
      <![CDATA[
        END;
      ]]>
    </delete>

    <!-- 还原回收站数据 -->
    <update id="Restore" parameterClass="Params">
      <![CDATA[
        DECLARE
          sql_temp VARCHAR2(1000);
          CURSOR cur_recyclebin IS SELECT * FROM RBAC.Recyclebin WHERE Id IN
      ]]>
      <iterate property="Values" open="(" close=");" conjunction=",">
        #Values[]#
      </iterate>
      <![CDATA[
        BEGIN
          FOR rec IN cur_recyclebin
          LOOP
            sql_temp:='UPDATE '|| rec.TableName || ' set Status=1 WHERE ' || rec.ColumnName || '=:1';
            EXECUTE IMMEDIATE sql_temp USING rec.Value;
    
            DELETE FROM RBAC.Recyclebin WHERE id=rec.Id;
          END LOOP;
        END;
      ]]>
    </update>

    <!-- 清空回收站数据 -->
    <update id="Clear" parameterClass="Params">
      <![CDATA[
        DECLARE
          sql_temp VARCHAR2(1000);
          CURSOR cur_recyclebin IS SELECT * FROM RBAC.Recyclebin WHERE Id IN
      ]]>
      <iterate property="Values" open="(" close=");" conjunction=",">
        #Values[]#
      </iterate>
      <![CDATA[
        BEGIN
          FOR rec IN cur_recyclebin
          LOOP
            sql_temp:='DELETE FROM '|| rec.TableName || ' where ' || rec.ColumnName || '=:1';
            EXECUTE IMMEDIATE sql_temp USING rec.Value;
    
            DELETE FROM RBAC.Recyclebin WHERE id=rec.Id;
          END LOOP;
        END;
      ]]>
    </update>
  </statements>
</sqlMap>