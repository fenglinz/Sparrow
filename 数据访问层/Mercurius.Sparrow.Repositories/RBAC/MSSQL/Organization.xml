<?xml version="1.0" encoding="utf-8" ?>
<sqlMap namespace="Mercurius.Sparrow.Repositories.RBAC.Organization" xmlns="http://ibatis.apache.org/mapping">
  <alias>
    <typeAlias alias="Organization" type="Mercurius.Sparrow.Entities.RBAC.Organization, Mercurius.Sparrow.Entities"/>
    <typeAlias alias="StaffOrganize" type="Mercurius.Sparrow.Entities.RBAC.StaffOrganize, Mercurius.Sparrow.Entities"/>
  </alias>

  <statements>
    <select id="GetOrganization" parameterClass="string" resultClass="Organization">
      <![CDATA[
        SELECT
		      a.Id
		      ,a.ParentId
		      ,a.Code
		      ,a.Name
		      ,a.InnerPhone
		      ,a.OuterPhone
		      ,a.Manager
          ,u1.Name AS ManagerName
		      ,a.AssistantManager
          ,u2.Name AS AssistantManagerName
		      ,a.Fax
		      ,a.ZipCode
		      ,a.Address
		      ,a.Sort
		      ,a.Remark
		      ,a.CreateUserId
          ,u3.Name AS CreateUserName
		      ,a.CreateDateTime
		      ,a.ModifyUserId
          ,u4.Name AS ModifyUserName
		      ,a.ModifyDateTime
		      ,a.Status
          FROM RBAC.Organization a
          LEFT JOIN RBAC.[User] u1
            ON a.Manager=u1.Id
          LEFT JOIN RBAC.[User] u2
            ON a.AssistantManager=u2.Id
          LEFT JOIN RBAC.[User] u3
            ON a.CreateUserId=u3.Id
          LEFT JOIN RBAC.[User] u4
            ON a.ModifyUserId=u4.Id
          WHERE a.Id=#value#
      ]]>
    </select>

    <select id="GetOrganizations" resultClass="Organization">
      <![CDATA[
        WITH CTE AS(
          SELECT
		        Id
		        ,ParentId
		        ,Code
		        ,Name
		        ,InnerPhone
		        ,OuterPhone
		        ,Manager
		        ,AssistantManager
		        ,Fax
		        ,ZipCode
		        ,Address
		        ,Sort
		        ,Remark
		        ,CreateUserId
		        ,CreateDateTime
		        ,ModifyUserId
		        ,ModifyDateTime
		        ,Status
            ,ROW_NUMBER() OVER(ORDER BY Sort ASC) AS orderId
          FROM RBAC.Organization
          WHERE ParentId='0'
          UNION ALL
          SELECT
		        a.Id
		        ,a.ParentId
		        ,a.Code
		        ,a.Name
		        ,a.InnerPhone
		        ,a.OuterPhone
		        ,a.Manager
		        ,a.AssistantManager
		        ,a.Fax
		        ,a.ZipCode
		        ,a.Address
		        ,a.Sort
		        ,a.Remark
		        ,a.CreateUserId
		        ,a.CreateDateTime
		        ,a.ModifyUserId
		        ,a.ModifyDateTime
		        ,a.Status
            ,cte.orderId*100+(ROW_NUMBER() OVER(ORDER BY a.sort ASC)) as orderId
          FROM RBAC.Organization a
          INNER JOIN cte
            ON a.ParentId=cte.id
        )
        SELECT 
          cte.*,
          u1.Name AS ManagerName,
          u2.Name AS AssistantManagerName,
          u3.Name AS CreateUserName,
          u4.Name AS ModifyUserName
        FROM cte
        LEFT JOIN RBAC.[User] u1
          ON cte.Manager=u1.Id
        LEFT JOIN RBAC.[User] u2
          ON cte.AssistantManager=u2.Id
        LEFT JOIN RBAC.[User] u3
          ON cte.CreateUserId=u3.Id
        LEFT JOIN RBAC.[User] u4
          ON cte.ModifyUserId=u4.Id
        WHERE cte.Status=1
        ORDER BY LTRIM(orderId)
      ]]>
    </select>

    <!-- 获取人员组织机构信息 -->
    <select id="GetStaffOrganizes" resultClass="StaffOrganize">
      <![CDATA[
        SELECT
          Id
          ,Name
          ,ParentId
          ,0 AS IsUser
        FROM RBAC.Organization
        UNION ALL
        SELECT
          U.ID
          ,U.Code+'|'+U.Name
          ,S.OrganizationId
          ,1 AS IsUser
        FROM RBAC.[User] U
        RIGHT JOIN RBAC.StaffOrganize S
          ON U.Id=S.UserId
      ]]>
    </select>

    <!--新增或修改组织信息-->
    <update id="CreateOrUpdate" parameterClass="Organization">
      <![CDATA[
        IF EXISTS(SELECT * FROM RBAC.Organization WHERE Id=#Id#)
          UPDATE RBAC.Organization
          SET 
            ParentId=#ParentId#,
            Code=#Code#,
            Name=#Name#,
            InnerPhone=#InnerPhone#,
            OuterPhone=#OuterPhone#,
            Manager=#Manager#,
            AssistantManager=#AssistantManager#,
            Fax=#Fax#,
            ZipCode=#ZipCode#,
            Address=#Address#,
            Sort=#Sort#,
            Remark=#Remark#,
            ModifyUserId=#ModifyUserId#,
            ModifyDateTime=GETDATE()
          WHERE Id=#Id#
        ELSE
          INSERT INTO RBAC.Organization
          (
            Id,
            ParentId,
            Code,
            Name,
            InnerPhone,
            OuterPhone,
            Manager,
            AssistantManager,
            Fax,
            ZipCode,
            Address,
            Sort,
            Remark,
            Status,
            CreateUserId,
            CreateDateTime
          )
          VALUES
          (
            NEWID(),
            #ParentId#,
            #Code#,
            #Name#,
            #InnerPhone#,
            #OuterPhone#,
            #Manager#,
            #AssistantManager#,
            #Fax#,
            #ZipCode#,
            #Address#,
            #Sort#,
            #Remark#,
            1,
            #CreateUserId#,
            GETDATE()
          )
      ]]>
    </update>

    <!-- 添加用户所有的部门 -->
    <insert id="AddRelations" parameterClass="Params">
      <![CDATA[
        DELETE FROM RBAC.StaffOrganize WHERE UserId=#UserId#;
      ]]>
      <isNotNull property="OrganizationIds">
        <![CDATA[
          INSERT INTO RBAC.StaffOrganize
          (
            Id,
            UserId,
            OrganizationId,
            CreateUserId,
            CreateDateTime
          )
          VALUES
        ]]>
        <iterate property="OrganizationIds" open="" close=";" conjunction=",">
          <![CDATA[
            (
              NEWID(),
              #UserId#,
              #OrganizationIds[]#,
              #CreateUserId#,
              GETDATE()
            )
          ]]>
        </iterate>
      </isNotNull>
    </insert>
  </statements>
</sqlMap>