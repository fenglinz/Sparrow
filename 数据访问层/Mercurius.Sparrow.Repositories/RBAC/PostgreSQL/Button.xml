<?xml version="1.0" encoding="utf-8" ?>
<sqlMap namespace="Mercurius.Sparrow.Repositories.RBAC.Button" xmlns="http://ibatis.apache.org/mapping">
  <alias>
    <typeAlias alias="Button" type="Mercurius.Sparrow.Entities.RBAC.Button, Mercurius.Sparrow.Entities" />
  </alias>

  <resultMaps>
    <resultMap id="Button" class="Button">
      <result property="Id" column="Id" />
      <result property="Name" column="Name" />
      <result property="Title" column="Title" />
      <result property="Image" column="Image" />
      <result property="Code" column="Code" />
      <result property="Sort" column="Sort" />
      <result property="Category" column="Category" />
      <result property="Remark" column="Remark" />
      <result property="CreateUserId" column="CreateUserId" />
      <result property="CreateUserName" column="CreateUserName" />
      <result property="CreateDateTime" column="CreateDateTime" />
      <result property="ModifyUserId" column="ModifyUserId" />
      <result property="ModifyUserName" column="ModifyUserName" />
      <result property="ModifyDateTime" column="ModifyDateTime" />
    </resultMap>
  </resultMaps>

  <statements>

    <!-- 获取按钮信息 -->
    <select id="GetButtons" parameterClass="string" resultMap="Button">
      <![CDATA[ 
        SELECT
          a."Id"
          ,a."Name"
          ,a."Title"
          ,a."Image"
          ,a."Code"
          ,a."Sort"
          ,a."Category"
          ,a."Remark"
          ,a."CreateUserId"
          ,u1."Name" AS "CreateUserName"
          ,a."CreateDateTime"
          ,a."ModifyUserId"
          ,u2."Name" AS "ModifyUserName"
          ,a."ModifyDateTime"
        FROM "RBAC"."Button" a
        LEFT JOIN "RBAC"."User" u1
          ON a."CreateUserId"=u1."Id"
        LEFT JOIN "RBAC"."User" u2
          ON a."ModifyUserId"=u2."Id"
        WHERE a."Status"=1
      ]]>
      <isNotNull property="." prepend="And">
        a."Id"=#Id#
      </isNotNull>
      <![CDATA[
        ORDER BY a."Sort" ASC
      ]]>
    </select>

    <!-- 获取链接未使用的按钮 -->
    <select id="GetUnUsedButtons" parameterClass="string" resultMap="Button">
      <![CDATA[
        WITH CTE AS (
	        SELECT "Name" from "RBAC"."Button"
	        EXCEPT
	        SELECT "Name" FROM "RBAC"."SystemMenu" WHERE "ParentId"=(SELECT "Id" FROM "RBAC"."SystemMenu" WHERE "Id"=#value#)
        )
        SELECT
          a."Id"
          ,a."Name"
          ,a."Title"
          ,a."Image"
          ,a."Code"
          ,a."Sort"
          ,a."Category"
          ,a."Remark"
          ,a."CreateUserId"
          ,u1."Name" AS "CreateUserName"
          ,a."CreateDateTime"
          ,a."ModifyUserId"
          ,u2."Name" AS "ModifyUserName"
          ,a."ModifyDateTime"
        FROM CTE
        INNER JOIN "RBAC"."Button" a
          ON a."Name"=cte."Name"
        LEFT JOIN "RBAC"."User" u1
          ON a."CreateUserId"=u1."Id"
        LEFT JOIN "RBAC"."User" u2
          ON a."ModifyUserId"=u2."Id"
        WHERE a."Status"=1
        ORDER BY "Sort" ASC
      ]]>
    </select>

    <!-- 新增修改RBAC.button -->
    <update id="CreateOrUpdate" parameterClass="Button">
      <![CDATA[
      BEGIN;
        UPDATE "RBAC"."Button"
          SET 
            "Name"=#Name#,
            "Title"=#Title#,
            "Image"=#Image#,
            "Code"=#Code#,
            "Sort"=#Sort#,
            "Category"=#Category#,
            "Remark"=#Remark#,
            "ModifyUserId"=#ModifyUserId#,
            "ModifyDateTime"=now()
          WHERE "Id"=#Id#;
          INSERT INTO "RBAC"."Button"
          (
            "Id",
            "Name",
            "Title",
            "Image",
            "Code",
            "Sort",
            "Category",
            "Remark",
            "Status",
            "CreateUserId",
            "CreateDateTime"
          )
          select uuid_generate_v4(), #Name#, #Title#, #Image#, #Code#, #Sort#, #Category#, #Remark#, 1, #CreateUserId#, now()
          WHERE NOT EXISTS(SELECT * FROM "RBAC"."Button" WHERE "Id"=#Id#);
      COMMIT;
      ]]>
    </update>
  </statements>
</sqlMap>
