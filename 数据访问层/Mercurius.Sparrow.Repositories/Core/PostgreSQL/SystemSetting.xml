<?xml version="1.0" encoding="utf-8" ?>
<sqlMap xmlns="http://ibatis.apache.org/mapping" namespace="Mercurius.Siskin.Repositories.Core.SystemSetting">
  <alias>
    <typeAlias alias="SystemSetting" type="Mercurius.Siskin.Entities.Core.SystemSetting, Mercurius.Siskin.Entities" />
  </alias>

  <resultMaps>
    <resultMap id="SystemSettingRM" class="SystemSetting">
      <result property="Id" column="Id" />
      <result property="ParentId" column="ParentId" />
      <result property="Name" column="Name" />
      <result property="Value" column="Value" />
      <result property="Remark" column="Remark" />
    </resultMap>
  </resultMaps>

  <statements>

    <!-- 获取系统配置信息 -->
    <select id="GetSetting" parameterClass="string" resultMap="SystemSettingRM">
      <![CDATA[
        SELECT
          "Id",
          "ParentId",
          "Name",
          "Value",
          "Remark"
        FROM "SystemSetting"
        WHERE "Name"=#value#        
      ]]>
    </select>

    <!-- 获取系统设置信息 -->
    <select id="GetSettings" parameterClass="string" resultMap="SystemSettingRM">
      <![CDATA[
        SELECT
          a."Id",
          a."ParentId",
          a."Name",
          a."Value",
          a."Remark"
        FROM "SystemSetting" a
        WHERE "Name"=#value# OR "ParentId" IN (
	        SELECT "Id" FROM "SystemSetting" WHERE "Name"=#value#
        )
      ]]>
    </select>

    <!-- 保存系统设置 -->
    <insert id="SaveSetting" parameterClass="SystemSetting">
      <![CDATA[
        BEGIN;
          UPDATE "SystemSetting"
          SET
            "Value"=#Value#
          WHERE "Name"=#Name#;
          INSERT INTO "SystemSetting"
          (
            "Id",
            "ParentId",
            "Name",
            "Value"
          )
          SELECT uuid_generate_v4(), #ParentId#, #Name#, #Value#
          WHERE NOT EXISTS(SELECT * FROM "SystemSetting" WHERE ("Name"=#Name# AND "ParentId" IS NULL) OR ("Name"=#Name# AND "ParentId"=#ParentId#));
        COMMIT;
      ]]>
    </insert>
  </statements>
</sqlMap>