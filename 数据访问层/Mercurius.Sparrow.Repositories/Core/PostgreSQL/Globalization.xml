<?xml version="1.0" encoding="utf-8" ?>
<sqlMap namespace="Mercurius.Sparrow.Repositories.Core.Globalization" xmlns="http://ibatis.apache.org/mapping">
  <alias>
    <typeAlias alias="Globalization" type="Mercurius.Sparrow.Entities.Core.Globalization, Mercurius.Sparrow.Entities"/>
    <typeAlias alias="GlobalizationSO" type="Mercurius.Sparrow.Entities.Core.SO.GlobalizationSO, Mercurius.Sparrow.Entities"/>
  </alias>

  <statements>

    <!-- 获取全局视图资源 -->
    <select id="GetGlobalResource" parameterClass="string" resultClass="string">
      <![CDATA[
        SELECT
          "Value" AS "a"
        FROM "Globalization" 
        WHERE "Area" IS NULL AND "Controller" IS NULL AND "ViewName" IS NULL AND "Key"=#value#
      ]]>
    </select>

    <!-- 获取视图资源信息 -->
    <select id="GetResources" parameterClass="Params" resultClass="DataTable">
      <![CDATA[
        SELECT
          "Key"
          ,"Value"
        FROM "Globalization"
        WHERE "Controller"=#Controller# AND "ViewName"=#View#
      ]]>
      <isNotNull property="Area">
        <isNotEmpty property="Area" prepend="AND">
          "Area"=#Area#
        </isNotEmpty>
      </isNotNull>
    </select>

    <!-- 获取全局视图资源信息 -->
    <select id="GetGlobalResources" parameterClass="SearchObject" resultClass="Globalization">
      <![CDATA[
        SELECT 
          "Id",
          "Area",
          "Controller",
          "ViewName",
          "Key",
          "Value",
          "Remark",
          ROW_NUMBER() OVER(ORDER BY "Area" ASC) AS "RowIndex"
        FROM "Globalization"
        WHERE "Area" IS NULL AND "Controller" IS NULL AND "ViewName" IS NULL
        ORDER BY "RowIndex" ASC
        OFFSET (#PageIndex#-1)*#PageSize#
        LIMIT #PageSize#
      ]]>
    </select>

    <!-- 获取全局视图资源信息总记录数 -->
    <select id="GetGlobalResourcesCount" resultClass="int">
      <![CDATA[
        SELECT COUNT(*) FROM "Globalization" WHERE "Area" IS NULL AND "Controller" IS NULL AND "ViewName" IS NULL
      ]]>
    </select>

    <!-- 获取资源信息 -->
    <select id="GetResource" parameterClass="string" resultClass="Globalization">
      <![CDATA[
        SELECT 
          "Id"
          ,"Area"
          ,"Controller"
          ,"ViewName" AS "View"
          ,"Key"
          ,"Value"
          ,"Remark"
        FROM "Globalization"
        WHERE "Id"=#value#
      ]]>
    </select>

    <!-- 获取本地视图资源信息 -->
    <select id="GetLocalResources" parameterClass="GlobalizationSO" resultClass="Globalization">
      <![CDATA[
        SELECT 
          "Id",
          "Area",
          "Controller",
          "ViewName" AS "View",
          "Key",
          "Value",
          "Remark",
          ROW_NUMBER() OVER(ORDER BY "Area" ASC) AS "RowIndex"
        FROM "Globalization"
        WHERE "Controller" IS NOT NULL AND "ViewName" IS NOT NULL
      ]]>
      <dynamic>
        <isNotNull property="AreaName">
          <isNotEmpty property="AreaName" prepend="AND">
            "Area" LIKE '%'||#AreaName#||'%'
          </isNotEmpty>
        </isNotNull>
        <isNotNull property="ControllerName">
          <isNotEmpty property="ControllerName" prepend="AND">
            "Controller" LIKE '%'||#ControllerName#||'%'
          </isNotEmpty>
        </isNotNull>
        <isNotNull property="View">
          <isNotEmpty property="View" prepend="AND">
            "ViewName" LIKE '%'||#View#||'%'
          </isNotEmpty>
        </isNotNull>
        <isNotNull property="Key">
          <isNotEmpty property="Key" prepend="AND">
            "Key" LIKE '%'||#Key#||'%'
          </isNotEmpty>
        </isNotNull>
      </dynamic>
      <![CDATA[
        ORDER BY "RowIndex" ASC
        OFFSET (#PageIndex#-1)*#PageSize#
        LIMIT #PageSize#
      ]]>
    </select>

    <!-- 获取本地视图资源信息总记录数 -->
    <select id="GetLocalResourcesCount" parameterClass="GlobalizationSO" resultClass="int">
      <![CDATA[
        SELECT 
          COUNT(*)
        FROM "Globalization" 
        WHERE "Controller" IS NOT NULL AND "ViewName" IS NOT NULL
      ]]>
      <dynamic>
        <isNotNull property="AreaName">
          <isNotEmpty property="AreaName" prepend="AND">
            "Area" LIKE '%'||#AreaName#||'%'
          </isNotEmpty>
        </isNotNull>
        <isNotNull property="ControllerName">
          <isNotEmpty property="ControllerName" prepend="AND">
            "Controller" LIKE '%'||#ControllerName#||'%'
          </isNotEmpty>
        </isNotNull>
        <isNotNull property="View">
          <isNotEmpty property="View" prepend="AND">
            "ViewName" LIKE '%'||#View#||'%'
          </isNotEmpty>
        </isNotNull>
        <isNotNull property="Key">
          <isNotEmpty property="Key" prepend="AND">
            "Key" LIKE '%'||#Key#||'%'
          </isNotEmpty>
        </isNotNull>
      </dynamic>
    </select>

    <!-- 添加或者编辑全局资源 -->
    <insert id="CreateOrUpdateGlobalResource" parameterClass="Params">
      <![CDATA[
        BEGIN;
          UPDATE "Globalization"
          SET
            "Value"=#Value#,
            "Remark"=#Remark#
          WHERE "Area" IS NULL AND "Controller" IS NULL AND "ViewName" IS NULL AND "Key"=#Key#;
          INSERT INTO "Globalization"
          (
            "Id",
            "Key",
            "Value",
            "Remark"
          ) 
          SELECT uuid_generate_v4(), #Key#, #Value#, #Remark#
          WHERE NOT EXISTS(SELECT 1 FROM "Globalization" WHERE "Area" IS NULL AND "Controller" IS NULL AND "ViewName" IS NULL AND "Key"=#Key#);
        COMMIT;
      ]]>
    </insert>

    <!-- 添加或者编辑资源信息 -->
    <update id="CreateOrUpdateResource" parameterClass="Globalization">
      <![CDATA[
        BEGIN;
          UPDATE "Globalization"
          SET
            "Area"=#Area#,
            "Controller"=#Controller#,
            "ViewName"=#View#,
            "key"=#Key#,
            "Value"=#Value#,
            "Remark"=#Remark#
          WHERE "Id"=#Id#;
          INSERT INTO "Globalization"
          (
            "Id",
            "Area",
            "Controller",
            "ViewName",
            "Key",
            "Value",
            "Remark"
          )
          SELECT uuid_generate_v4(), #Area#, #Controller#, #View#, #Key#, #Value#, #Remark#
          WHERE NOT EXISTS(SELECT * FROM "Globalization" WHERE "Id"=#Id#);
        COMMIT;
      ]]>
    </update>

    <!-- 删除资源信息 -->
    <delete id="Remove" parameterClass="string">
      <![CDATA[
        DELETE FROM "Globalization" WHERE "Id"=#value#
      ]]>
    </delete>
  </statements>
</sqlMap>