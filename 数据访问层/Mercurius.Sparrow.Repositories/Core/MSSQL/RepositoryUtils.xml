<?xml version="1.0" encoding="utf-8" ?>
<sqlMap namespace="Mercurius.Siskin.Repositories.Core.RepositoryUtils" xmlns="http://ibatis.apache.org/mapping">
  <alias>
    <typeAlias alias="Partition" type="Mercurius.Siskin.Entities.Core.Partition, Mercurius.Siskin.Entities" />
  </alias>

  <resultMaps>
    <resultMap id="GetPartitionsRM" class="Partition">
      <result property="Name" column="PARTITION_NAME" />
      <result property="HightValue" column="HIGH_VALUE" dbType="RAW" type="string" />
    </resultMap>
  </resultMaps>
  
  <statements>

    <!-- 判断数据库表的字段是否存在 -->
    <select id="IsColumnExists" parameterClass="Params" resultClass="int">
      <![CDATA[
        SELECT
          1 AS COUNT
        WHERE EXISTS
        (
          SELECT
           *
          FROM syscolumns a
          LEFT JOIN systypes b
            ON a.xusertype=b.xusertype 
          INNER JOIN sys.objects c
            ON a.id=c.object_id
          INNER JOIN sys.schemas s
            ON c.schema_id=s.schema_id
          WHERE s.name=#Schema# AND c.name=#Table# AND a.name=#Column#
        )
      ]]>
    </select>
    
    <!-- 获取表的分区 -->
    <select id="GetPartitions" parameterClass="string" resultClass="DataTable">
      <![CDATA[
        SELECT
          CAST(a.partition_number AS VARCHAR(100)) AS Name,
          a.data_compression_desc As HightValue
        FROM SYS.PARTITIONS a
        INNER JOIN sys.objects b
          ON a.object_id=b.object_id
        WHERE b.type='U' AND b.Name=#value#
      ]]>
    </select>

    <!-- 判断表中的数据是否存在 -->
    <select id="IsDataExists" parameterClass="Params" resultClass="int">
      <![CDATA[
        SELECT
          COUNT(1) AS COUNT
        WHERE EXISTS(SELECT * FROM [$Schema$].[$Table$] WHERE Status=1 AND [$Column$] IN
      ]]>
      <iterate property="Values" open="(" close="))" conjunction=",">
        #Values[]#
      </iterate>
    </select>
  </statements>
</sqlMap>