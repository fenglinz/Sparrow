<?xml version="1.0" encoding="utf-8" ?>
<sqlMap namespace="Mercurius.Sparrow.Repositories.Core.Logger" xmlns="http://ibatis.apache.org/mapping">
  <alias>
    <typeAlias alias="Log" type="Mercurius.Sparrow.Entities.Core.Log, Mercurius.Sparrow.Entities" />
    <typeAlias alias="LogSO" type="Mercurius.Sparrow.Entities.Core.SO.LogSO, Mercurius.Sparrow.Entities" />
  </alias>

  <statements>

    <!-- 获取日志级别 -->
    <select id="GetLoggerLevel" resultClass="string">
      <![CDATA[
				SELECT Value FROM SystemSetting t WHERE Name='LogLevel'
			]]>
    </select>

    <!-- 获取日志信息 -->
    <select id="GetLog" parameterClass="Params" resultClass="Log">
      <![CDATA[
        SELECT
          Id
          ,LogOnId
          ,LogOnName
          ,LogOnIP
          ,ModelName
          ,Summary
          ,Details
          ,LogLevel AS [Level]
          ,OccurrenceDateTime
        FROM SYSTEMLOG
      ]]>
      <dynamic>
        <isNotNull property="Partition">
          <isNotEmpty property="Partition">
            PARTITION($Partition$)
          </isNotEmpty>
        </isNotNull>
      </dynamic>
      <![CDATA[
        WHERE Id=#Id#
      ]]>
    </select>

    <!-- 获取日志信息 -->
    <select id="GetLogs" parameterClass="LogSO" resultClass="Log">
      <![CDATA[
        WITH CTE AS(
          SELECT 
            Id,
            LogOnId,
            LogOnName,
            LogOnIP,
            ModelName,
            Summary,
            LogLevel,
            OccurrenceDateTime,
            ROW_NUMBER() OVER(ORDER BY OccurrenceDateTime DESC) AS RowIndex
          FROM SYSTEMLOG 
      ]]>
      <dynamic prepend="WHERE">
        <isNotEmpty property="Partition">
          PARTITION($Partition$)
        </isNotEmpty>
        <isNotEmpty property="Level" prepend="AND">
          LogLevel=#Level#
        </isNotEmpty>
        <isNotNull property="StartDate" prepend="AND">
          OccurrenceDateTime>=#StartDate#
        </isNotNull>
        <isNotNull property="EndDate" prepend="AND">
          <![CDATA[
              OccurrenceDateTime<=#EndDate#
            ]]>
        </isNotNull>
        <isNotEmpty property="LogOnName" prepend="AND">
          LOGONNAME LIKE '%'+#LogOnName#+'%'
        </isNotEmpty>
        <isNotEmpty property="LogOnIP" prepend="AND">
          LOGONIP LIKE '%'+#LogOnIP#+'%'
        </isNotEmpty>
        <isNotEmpty property="ModelName" prepend="AND">
          MODELNAME LIKE '%'+#ModelName#+'%'
        </isNotEmpty>
      </dynamic>
      <![CDATA[
        )
        SELECT * FROM CTE 
        WHERE RowIndex BETWEEN (#PageIndex#-1)*#PageSize#+1 AND #PageIndex#*#PageSize#
        ORDER BY RowIndex ASC
      ]]>
    </select>

    <!-- 获取日志信息查询记录数 -->
    <select id="GetLogsCount" parameterClass="Params" resultClass="int">
      <![CDATA[
        SELECT 
          COUNT(*)
        FROM SYSTEMLOG 
      ]]>
      <dynamic prepend="WHERE">
        <isNotEmpty property="Partition">
          PARTITION($Partition$)
        </isNotEmpty>
        <isNotEmpty property="Level" prepend="AND">
          LogLevel=#Level#
        </isNotEmpty>
        <isNotNull property="StartDate" prepend="AND">
          OccurrenceDateTime>=#StartDate#
        </isNotNull>
        <isNotNull property="EndDate" prepend="AND">
          <![CDATA[
              OccurrenceDateTime<=#EndDate#
            ]]>
        </isNotNull>
        <isNotEmpty property="LogOnName" prepend="AND">
          LOGONNAME LIKE '%'+#LogOnName#+'%'
        </isNotEmpty>
        <isNotEmpty property="LogOnIP" prepend="AND">
          LOGONIP LIKE '%'+#LogOnIP#+'%'
        </isNotEmpty>
        <isNotEmpty property="ModelName" prepend="AND">
          MODELNAME LIKE '%'+#ModelName#+'%'
        </isNotEmpty>
      </dynamic>
    </select>

    <!-- 添加日志信息 -->
    <insert id="Write" parameterClass="Log">
      <![CDATA[
        INSERT INTO SystemLog
        (
           Id
           ,LogOnId
           ,LogOnName
           ,LogOnIP
           ,ModelName
           ,Summary
           ,Details
           ,OccurrenceDateTime
           ,LogLevel
        )
        VALUES
        (
           #Id#
           ,#LogOnId#
           ,#LogOnName#
           ,#LogOnIP#
           ,#ModelName#
           ,#Summary#
           ,#Details#
           ,#OccurrenceDateTime#
           ,#Level#
        )
      ]]>
    </insert>

    <!-- 清空日志记录 -->
    <delete id="ClearLogs">
      <![CDATA[
        TRUNCATE TABLE SystemLog
      ]]>
    </delete>
  </statements>
</sqlMap>