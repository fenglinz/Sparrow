<?xml version="1.0" encoding="utf-8" standalone="yes"?>
<sqlMap namespace="Mercurius.Sparrow.Repositories.Core.FileStorage" xmlns="http://ibatis.apache.org/mapping">
  <alias>
    <typeAlias alias="FileUpload" type="Mercurius.Sparrow.Entities.Core.FileUpload, Mercurius.Sparrow.Entities" />
    <typeAlias alias="FileStorage" type="Mercurius.Sparrow.Entities.Core.FileStorage,Mercurius.Sparrow.Entities" />
    <typeAlias alias="FileStorageSO" type="Mercurius.Sparrow.Entities.Core.SO.FileStorageSO,Mercurius.Sparrow.Entities" />
  </alias>
  <statements>

    <!-- 添加或者修改上传文件信息 -->
    <update id="CreateOrUpdate" parameterClass="FileStorage">
      <![CDATA[
        IF EXISTS(SELECT * FROM [FileStorage] WHERE [SaveAsPath]=#SaveAsPath#)
          UPDATE [FileStorage]
          SET
            [BusinessCategory]=#BusinessCategory#,
            [BusinessSerialNumber]=#BusinessSerialNumber#,
            [FileName]=#FileName#,
            [ContentType]=#ContentType#,
            [FileSize]=#FileSize#,
            [Description]=#Description#,
            [UploadUserId]=#UploadUserId#,
            [UploadDateTime]=GETDATE()
          WHERE [SaveAsPath]=#SaveAsPath#
        ELSE
          INSERT INTO [FileStorage]
          (
            [Category],
            [BusinessCategory],
            [BusinessSerialNumber],
            [FileName],
            [ContentType],
            [FileSize],
            [Description],
            [SaveAsPath],
            [UploadUserId],
            [UploadDateTime]
          )
          VALUES
          (
            #Category#,
            #BusinessCategory#,
            #BusinessSerialNumber#,
            #FileName#,
            #ContentType#,
            #FileSize#,
            #Description#,
            #SaveAsPath#,
            #UploadUserId#,
            GETDATE()
          )
      ]]>
    </update>

    <!-- 上传文件信息。 -->
    <select id="UploadFiles" parameterClass="FileUpload" resultClass="string">
      <![CDATA[
        BEGIN
      ]]>
      <isNotNull property="Items">
        <iterate property="Items" open="" conjunction="" close="">
          <![CDATA[
            IF EXISTS(SELECT * FROM [FileStorage] WHERE [SaveAsPath]=#Items[].SavedAsFilePath#)
              UPDATE [FileStorage]
              SET
                [BusinessCategory]=#BusinessCategory#,
                [BusinessSerialNumber]=#BusinessSerialNumber#,
                [FileName]=ISNULL(CASE #Items[].FileName# WHEN '' THEN NULL ELSE #Items[].FileName# END, [FileName]),
                [ContentType]=ISNULL(CASE #Items[].ContentType# WHEN '' THEN NULL ELSE #Items[].ContentType# END, [ContentType]),
                [FileSize]=ISNULL(CASE #Items[].FileSize# WHEN '' THEN NULL ELSE #Items[].FileSize# END, [FileSize]),
                [Description]=#Items[].Description#,
                [UploadUserId]=#UploadUserId#,
                [UploadDateTime]=GETDATE()
              WHERE [SaveAsPath]=#Items[].SavedAsFilePath#
            ELSE
              INSERT INTO [FileStorage]
              (
                [Category],
                [BusinessCategory],
                [BusinessSerialNumber],
                [FileName],
                [ContentType],
                [FileSize],
                [Description],
                [SaveAsPath],
                [UploadUserId],
                [UploadDateTime]
              )
              VALUES
              (
                #Items[].Category#,
                #BusinessCategory#,
                #BusinessSerialNumber#,
                #Items[].FileName#,
                #Items[].ContentType#,
                #Items[].FileSize#,
                #Items[].Description#,
                #Items[].SavedAsFilePath#,
                #UploadUserId#,
                GETDATE()
              )
          ]]>
        </iterate>
      </isNotNull>
      <![CDATA[
          SELECT
            SaveAsPath
          FROM [FileStorage]
          WHERE BusinessCategory=#BusinessCategory# AND [BusinessSerialNumber]=#BusinessSerialNumber#;
        END
      ]]>
    </select>

    <!-- 删除上传文件信息。 -->
    <delete id="Remove" parameterClass="int">
      <![CDATA[
        DELETE FROM [FileStorage] WHERE [Id]=#value#
      ]]>
    </delete>

    <!-- 删除上传文件信息 -->
    <delete id="RemovesByFilePaths" parameterClass="Params">
      <isNotNull property="FilePaths">
        <![CDATA[
          DELETE FROM [FileStorage] WHERE SaveAsPath IN
        ]]>
        <iterate property="FilePaths" open="(" conjunction="," close=")">
          #FilePaths[]#
        </iterate>
      </isNotNull>
    </delete>

    <!-- 根据主键获取上传文件信息。 -->
    <select id="GetById" parameterClass="int" resultClass="FileStorage">
      <![CDATA[
        SELECT TOP 1 
          [Id] AS Id,
          [Category] AS Category,
          [BusinessCategory] AS BusinessCategory,
          [BusinessSerialNumber] AS BusinessSerialNumber,
          [FileName] AS FileName,
          [ContentType] AS ContentType,
          [FileSize] AS FileSize,
          [Description] AS Description,
          [SaveAsPath] AS SaveAsPath,
          [UploadUserId] AS UploadUserId,
          [UploadDateTime] AS UploadDateTime
        FROM [FileStorage]
        WHERE [Id]=#value#
      ]]>
    </select>

    <!-- 根据文件保存路径获取文件信息 -->
    <select id="GetFileStorageByPath" parameterClass="string" resultClass="FileStorage">
      <![CDATA[
        SELECT TOP 1 
          [Id] AS Id,
          [Category] AS Category,
          [BusinessCategory] AS BusinessCategory,
          [BusinessSerialNumber] AS BusinessSerialNumber,
          [FileName] AS FileName,
          [ContentType] AS ContentType,
          [FileSize] AS FileSize,
          [Description] AS Description,
          [SaveAsPath] AS SaveAsPath,
          [UploadUserId] AS UploadUserId,
          [UploadDateTime] AS UploadDateTime
        FROM [FileStorage]
        WHERE [SaveAsPath]=#value#
      ]]>
    </select>

    <!-- 获取业务所用文件信息 -->
    <select id="GetBusinessFiles" parameterClass="Params" resultClass="FileStorage">
      <![CDATA[
        SELECT
          [Id] AS Id,
          [Category] AS Category,
          [BusinessCategory] AS BusinessCategory,
          [BusinessSerialNumber] AS BusinessSerialNumber,
          [FileName] AS FileName,
          [ContentType] AS ContentType,
          [FileSize] AS FileSize,
          [Description] AS Description,
          [SaveAsPath] AS SaveAsPath,
          [UploadUserId] AS UploadUserId,
          [UploadDateTime] AS UploadDateTime
        FROM [FileStorage]
        WHERE BusinessCategory=#Category# AND BusinessSerialNumber=#SerialNumber#
      ]]>
      <dynamic>
        <isEqual property="IncludeFromRichEditor" compareValue="false" prepend="AND">
          <![CDATA[
            [Category]=1
          ]]>
        </isEqual>
      </dynamic>
    </select>

    <!-- 分页返回满足查询条件的上传文件信息。 -->
    <select id="SearchFileStorages" parameterClass="FileStorageSO" resultClass="FileStorage">
      <![CDATA[
        WITH CTE AS(
          SELECT
            a.[Id] AS Id,
            [Category] AS Category,
            [BusinessCategory] AS BusinessCategory,
            [BusinessSerialNumber] AS BusinessSerialNumber,
            [FileName] AS FileName,
            [ContentType] AS ContentType,
            [FileSize] AS FileSize,
            a.[Description] AS Description,
            [SaveAsPath] AS SaveAsPath,
            [UploadUserId] AS UploadUserId,
            CASE WHEN b.[Name] IS NULL THEN c.[Description] ELSE b.[Name] END AS UploadUserName,
            [UploadDateTime] AS UploadDateTime,
            ROW_NUMBER() OVER(ORDER BY a.[Id] DESC) AS RowIndex
          FROM [FileStorage] a
          LEFT JOIN [RBAC].[User] b ON a.UploadUserId=b.Id
          LEFT JOIN [WebApi].[User] c ON a.UploadUserId=Cast(c.Id AS NVARCHAR(36))
      ]]>
      <include refid="searchConditions" />
      <![CDATA[
        )
        SELECT * FROM CTE
        WHERE RowIndex BETWEEN (#PageIndex#-1)*#PageSize#+1 AND #PageIndex#*#PageSize#
        ORDER BY RowIndex ASC
      ]]>
    </select>

    <!-- 返回满足查询条件的记录数。 -->
    <select id="SearchFileStoragesCount" parameterClass="FileStorageSO" resultClass="int">
      <![CDATA[
        SELECT
          COUNT(*) 
        FROM [FileStorage] a
        LEFT JOIN [RBAC].[User] b
          ON a.UploadUserId=b.Id
      ]]>
      <include refid="searchConditions" />
    </select>

    <!-- 查询条件。 -->
    <sql id="searchConditions">
      <dynamic prepend="WHERE">
        <isNotNull property=".">
          <isNotEmpty property="FileName" prepend="AND">
            FileName LIKE '%'+#FileName#+'%'
          </isNotEmpty>
          <isNotEmpty property="ContentType" prepend="AND">
            ContentType LIKE '%'+#ContentType#+'%'
          </isNotEmpty>
          <isNotEmpty property="UploadUserName" prepend="AND">
            b.[Name] LIKE '%'+#UploadUserName#+'%'
          </isNotEmpty>
          <isNotNull property="StartUploadDate" prepend="AND">
            UploadDateTime>=#StartUploadDate#
          </isNotNull>
          <isNotNull property="EndUploadDate" prepend="AND">
            <![CDATA[
              CONVERT(NVARCHAR(10), UploadDateTime, 120)<=#EndUploadDate#
            ]]>
          </isNotNull>
        </isNotNull>
      </dynamic>
    </sql>

    <!-- 获取无效的文件列表 -->
    <select id="GetInvalidFiles" resultClass="string">
      <![CDATA[
        WITH cte AS(
          SELECT 
            a.SaveAsPath
          FROM dbo.FileStorage a
          LEFT JOIN dbo.News b
          ON a.BusinessCategory='新闻管理' AND a.BusinessSerialNumber=b.Id
          WHERE b.Id IS NULL
        )
        SELECT TOP 100 * FROM cte
      ]]>
    </select>

    <!-- 获取未管理的文件列表 -->
    <select id="GetUnmanagedFiles" parameterClass="string" resultClass="string">
      <![CDATA[
        SELECT
          b.Item
        FROM FileStorage a
        RIGHT JOIN Split(#value#, ',') b ON a.SaveAsPath=b.Item
        WHERE a.Id IS NULL AND b.Item<>'';
      ]]>
    </select>
  </statements>
</sqlMap>