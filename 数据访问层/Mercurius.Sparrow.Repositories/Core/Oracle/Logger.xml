<?xml version="1.0" encoding="utf-8" ?>
<sqlMap namespace="Mercurius.Siskin.Repositories.Core.Logger" xmlns="http://ibatis.apache.org/mapping">
  <alias>
    <typeAlias alias="Log" type="Mercurius.Siskin.Entities.Core.Log, Mercurius.Siskin.Entities" />
  </alias>

  <statements>

    <!-- 获取日志级别 -->
    <select id="GetLoggerLevel" resultClass="string">
      <![CDATA[
        SELECT Value FROM SYSTEM_CONFIG t WHERE KEY='日志级别'
      ]]>
    </select>

    <!-- 获取日志信息 -->
    <select id="GetLog" parameterClass="Params" resultClass="Log">
      <![CDATA[
        SELECT
          Id                  AS "Id"
          ,LogOnId            AS "LogOnId"
          ,LogOnName          AS "LogOnName"
          ,LogOnIP            AS "LogOnIP"
          ,ModelName          AS "ModelName"
          ,Summary            AS "Summary"
          ,Details            AS "Details"
          ,LogLevel           AS "Level"
          ,OccurrenceDateTime AS "OccurrenceDateTime"
        FROM SystemLog
      ]]>
      <dynamic>
        <isNotNull property="Partition">
          <isNotEmpty property="Partition">
            PARTITION($Partition$)
          </isNotEmpty>
        </isNotNull>
      </dynamic>
      <![CDATA[
        WHERE Id=#Id#
      ]]>
    </select>

    <!-- 获取日志信息 -->
    <select id="GetLogs" parameterClass="Params" resultClass="Log">
      <![CDATA[
        WITH CTE AS(
          SELECT 
            Id,
            LogOnId,
            LogOnName,
            LogOnIP,
            ModelName,
            Summary,
            LogLevel,
            OccurrenceDateTime
          FROM SystemLog 
      ]]>
      <isNotEmpty property="Partition">
        PARTITION($Partition$)
      </isNotEmpty>
      <dynamic prepend="WHERE">
        <isNotNull property="SO">
          <isNotEmpty property="SO.Level" prepend="AND">
            LogLevel=#SO.Level#
          </isNotEmpty>
          <isNotNull property="SO.StartDate" prepend="AND">
            OccurrenceDateTime>=#SO.StartDate#
          </isNotNull>
          <isNotNull property="SO.EndDate" prepend="AND">
            <![CDATA[
              OccurrenceDateTime<=#SO.EndDate#
            ]]>
          </isNotNull>
          <isNotEmpty property="SO.LogOnName" prepend="AND">
            LOGONNAME LIKE '%'||#SO.LogOnName#||'%'
          </isNotEmpty>
          <isNotEmpty property="SO.LogOnIP" prepend="AND">
            LOGONIP LIKE '%'||#SO.LogOnIP#||'%'
          </isNotEmpty>
          <isNotEmpty property="SO.ModelName" prepend="AND">
            MODELNAME LIKE '%'||#SO.ModelName#||'%'
          </isNotEmpty>
        </isNotNull>
      </dynamic>
      <![CDATA[
	        ORDER BY OccurrenceDateTime ASC
        ),
        PAGING AS (
          SELECT 
            ROWNUM AS RowIndex,
            CTE.*
          FROM CTE
        )
        SELECT
          PAGING.RowIndex            AS "RowIndex"
          ,PAGING.Id                 AS "Id"
          ,PAGING.LogOnId            AS "LogOnId"
          ,PAGING.LogOnName          AS "LogOnName"
          ,PAGING.LogOnIP            AS "LogOnIP"
          ,PAGING.ModelName          AS "ModelName"
          ,PAGING.Summary            AS "Summary"
          ,PAGING.LogLevel           AS "Level"
          ,PAGING.OccurrenceDateTime AS "OccurrenceDateTime"
        FROM PAGING 
        WHERE RowIndex BETWEEN (#SO.PageIndex#-1)*#SO.PageSize#+1 AND #SO.PageIndex#*#SO.PageSize#
      ]]>
    </select>

    <!-- 获取日志信息查询记录数 -->
    <select id="GetLogsCount" parameterClass="Params" resultClass="int">
      <![CDATA[
        SELECT 
          COUNT(*)
        FROM SystemLog 
      ]]>
      <isNotEmpty property="Partition">
        PARTITION($Partition$)
      </isNotEmpty>
      <dynamic prepend="WHERE">
        <isNotNull property="SO">
          <isNotEmpty property="SO.Level" prepend="AND">
            LogLevel=#SO.Level#
          </isNotEmpty>
          <isNotNull property="SO.StartDate" prepend="AND">
            OccurrenceDateTime>=#SO.StartDate#
          </isNotNull>
          <isNotNull property="SO.EndDate" prepend="AND">
            <![CDATA[
              OccurrenceDateTime<=#SO.EndDate#
            ]]>
          </isNotNull>
          <isNotEmpty property="SO.LogOnName" prepend="AND">
            LOGONNAME LIKE '%'||#SO.LogOnName#||'%'
          </isNotEmpty>
          <isNotEmpty property="SO.LogOnIP" prepend="AND">
            LOGONIP LIKE '%'||#SO.LogOnIP#||'%'
          </isNotEmpty>
          <isNotEmpty property="SO.ModelName" prepend="AND">
            MODELNAME LIKE '%'||#SO.ModelName#||'%'
          </isNotEmpty>
        </isNotNull>
      </dynamic>
    </select>

    <!-- 添加日志信息 -->
    <insert id="Write" parameterClass="Log">
      <![CDATA[
        INSERT INTO SystemLog
        (
           Id
           ,LogOnId
           ,LogOnName
           ,LogOnIP
           ,ModelName
           ,Summary
           ,Details
           ,OccurrenceDateTime
           ,LogLevel
        )
        VALUES
        (
           #Id#
           ,#LogOnId#
           ,#LogOnName#
           ,#LogOnIP#
           ,#ModelName#
           ,#Summary#
           ,#Details#
           ,#OccurrenceDateTime#
           ,#Level#
        )
      ]]>
    </insert>

    <!-- 清空日志记录 -->
    <delete id="ClearLogs">
      <![CDATA[
        TRUNCATE TABLE SystemLog
      ]]>
    </delete>
  </statements>
</sqlMap>