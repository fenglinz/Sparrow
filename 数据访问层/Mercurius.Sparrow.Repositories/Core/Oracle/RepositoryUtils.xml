<?xml version="1.0" encoding="utf-8" ?>
<sqlMap namespace="Mercurius.Siskin.Repositories.Core.RepositoryUtils" xmlns="http://ibatis.apache.org/mapping">
  <alias>
    <typeAlias alias="Column" type="Mercurius.Siskin.Entities.Core.Column, Mercurius.Siskin.Entities" />
    <typeAlias alias="Partition" type="Mercurius.Siskin.Entities.Core.Partition, Mercurius.Siskin.Entities" />
  </alias>

  <resultMaps>
    <resultMap id="GetPartitionsRM" class="Partition">
      <result property="Name" column="PARTITION_NAME" />
      <result property="HightValue" column="HIGH_VALUE" dbType="RAW" type="string" />
    </resultMap>
  </resultMaps>
  
  <statements>

    <!-- 获取用户自定义数据库表名称 -->
    <select id="GetTables" parameterClass="string" resultClass="string">
      <![CDATA[
        SELECT TABLE_NAME FROM USER_TABLES
      ]]>
    </select>

    <!-- 判断表是否存在 -->
    <select id="IsTableExists" parameterClass="string" resultClass="int">
      <![CDATA[
        SELECT 
          COUNT(1) COUNT
        FROM dual 
        WHERE EXISTS(
          SELECT * FROM user_tables WHERE table_name=#value#
        )
      ]]>
    </select>

    <!-- 获取表的分区 -->
    <select id="GetPartitions" parameterClass="string" resultClass="DataTable">
      <![CDATA[
        SELECT
          Partition_Name AS "Name",
          high_value AS "HightValue"
        FROM User_Tab_Partitions
        WHERE TABLE_NAME=#value#
      ]]>
    </select>

    <!-- 获取数据库表的元数据信息 -->
    <select id="GetMetadataByTable" parameterClass="string" resultClass="Column">
      <![CDATA[
        SELECT
          b.COLUMN_NAME AS "Name"
          ,DATA_TYPE AS "DataType"
          ,DATA_LENGTH AS "DataLength"
          ,(CASE NULLABLE 
            WHEN 'Y' THEN '√'
              ELSE ''
            END
          ) AS "Nullable"
          ,b.data_default AS "DataDefault"
          ,c.comments as "Comments"
        FROM USER_TABLES A 
        INNER JOIN USER_TAB_COLUMNS B 
          ON A.TABLE_NAME=B.TABLE_NAME 
        LEFT JOIN USER_COL_COMMENTS c 
          ON A.TABLE_NAME=C.TABLE_NAME AND B.COLUMN_NAME=C.COLUMN_NAME
        WHERE upper(A.TABLE_NAME)=upper(#value#)
        ORDER BY COLUMN_ID
      ]]>
    </select>

    <!-- 判断数据库表的字段是否存在 -->
    <select id="IsColumnExists" parameterClass="Params" resultClass="int">
      <![CDATA[
        SELECT
          COUNT(1) AS COUNT
        FROM DUAL
        WHERE EXISTS(
          SELECT * FROM USER_TAB_COLUMNS 
          WHERE TABLE_NAME= UPPER(#Table#) AND COLUMN_NAME=UPPER(#Column#))
      ]]>
    </select>

    <!-- 判断表中的数据是否存在 -->
    <select id="IsDataExists" parameterClass="Params" resultClass="int">
      <![CDATA[
        SELECT
          COUNT(1) AS COUNT
        FROM DUAL 
        WHERE EXISTS(SELECT * FROM $Table$ WHERE Status=1 AND $Column$ IN
      ]]>
      <iterate property="Values" open="(" close="))" conjunction=",">
        #Values[]#
      </iterate>
    </select>
  </statements>
</sqlMap>