<?xml version="1.0" encoding="utf-8"?>
<sqlMap xmlns="http://ibatis.apache.org/mapping" namespace="Mercurius.Sparrow.Repositories.Core.Dictionary">
  <alias>
    <typeAlias alias="Dictionary" type="Mercurius.Sparrow.Entities.Core.Dictionary, Mercurius.Sparrow.Entities" />
  </alias>
  <statements>
    <!--根据条件获得字典信息-->
    <select id="GetDictionarys" parameterClass="Dictionary" resultClass="Dictionary">
      <![CDATA[
        SELECT
          a.Id                                                             AS "Id"
          ,a.Key                                                           AS "Key"
          ,a.Value                                                         AS "Value"
          ,a.Status                                                        AS "Status"
          ,a.Remark                                                        AS "Remark"
          ,a.ParentId                                                      AS "ParentId"
          ,a.Sort                                                          AS "Sort"
          ,CAST(b.Sort AS VARCHAR2(10))||'-'||CAST(b.Sort AS VARCHAR2(10)) AS "FullSort"
          ,b.Key                                 AS "ParentName"
        FROM Dictionary a 
        LEFT JOIN Dictionary b 
          ON a.ParentId=b.Id 
        WHERE a.ParentId!='00000000-0000-0000-0000-000000000000'
      ]]>
      <dynamic>
        <isNotNull prepend="and" property="Id">
          <![CDATA[
          a.Id=#Id#
        ]]>
        </isNotNull>
        <isNotNull prepend="and" property="ParentId">
          <![CDATA[
          a.ParentId=#ParentId#
        ]]>
        </isNotNull>
        <isNotNull prepend="and" property="Status">
          <![CDATA[
          a.Status=#Status#
        ]]>
        </isNotNull>
      </dynamic>
      <![CDATA[
         ORDER BY b.Sort ASC,a.Sort ASC
      ]]>
    </select>

    <!--获得字典表中所有的字典类型-->
    <select id="GetDictionaryType" resultClass="Dictionary">
      <![CDATA[
        SELECT
          Id   AS "Id"
          ,Key AS "Key"
        FROM Dictionary
        WHERE ParentId='00000000-0000-0000-0000-000000000000'
        ORDER BY Sort
      ]]>
    </select>

    <select id="GetMaxOrderNumberOfDicType" resultClass="int?">
      <![CDATA[
        SELECT
          MAX(Sort) 
        FROM Dictionary
        WHERE ParentId='00000000-0000-0000-0000-000000000000'
      ]]>
    </select>

    <!--插入或更新字典信息-->
    <insert id="InsertOrUpdateDictionary" parameterClass="Params">
      <![CDATA[
        DECLARE
          newGuid NCHAR(36);
        begin
          newGuid:=UTIL.NEWGUID;
          MERGE INTO Dictionary dic
          USING (SELECT * FROM Dictionary WHERE Id=#DicModel.Id#) src
          ON (dic.Id=src.Id)
          WHEN MATCHED THEN
            UPDATE SET
              dic.Key=#DicModel.Key#,
              dic.Value=#DicModel.Value#,
              dic.ParentId=#DicModel.ParentId#,
              dic.Sort=#DicModel.Sort#,
              dic.Status=#DicModel.Status#,
              dic.Remark=#DicModel.Remark#
          WHEN NOT MATCHED THEN 
            INSERT
            (
              dic.Id,
              dic.Key,
              dic.Value,
              dic.ParentId,
              dic.Sort,
              dic.Status,
              dic.Remark
            ) 
            VALUES 
            (
              newGuid,
              #DicModel.Key#,
              #DicModel.Value#,
              #DicModel.ParentId#,
              #DicModel.Sort#,
              #DicModel.Status#,
              #DicModel.Remark#
            );
      ]]>
      <isNotNull property="DicList">
        <iterate property="DicList" open="" close=";" conjunction=";">
          <![CDATA[
            INSERT INTO Dictionary
            (
              Id,
              Key,
              Value,
              ParentId,
              Sort,
              Status,
              Remark
            ) 
            VALUES
            (
              UTIL.NEWGUID,
              #DicList[].Key#,
              #DicList[].Value#,
              NewGuid,
              #DicList[].Sort#,
              #DicList[].Status#,
              #DicList[].Remark#
            )
          ]]>
        </iterate>
      </isNotNull>
      <![CDATA[
        END;
      ]]>
    </insert>

    <!--根据ID删除字典信息-->
    <delete id="DeleteDictionary" parameterClass="Params">
      <![CDATA[
        DELETE FROM Dictionary WHERE Id in
      ]]>
      <iterate close=")" conjunction="," open="(" property="Values">
        <![CDATA[
          #Values[]#
        ]]>
      </iterate>
    </delete>

    <!--根据父Id获得字典-->
    <select id="GetDictionaryByParentId" parameterClass="string" resultClass="Dictionary">
      <![CDATA[
        SELECT
          Id     AS "Id"
          ,Key   AS "Key"
          ,Value AS "Value"
        FROM Dictionary 
        WHERE ParentId=#value# AND Status=1 
        ORDER BY Sort 
      ]]>
    </select>

    <!--jianx -->
    <!--根据传入的字典值，获取字典类别-->
    <select id="GetParentValue" parameterClass="string" resultClass="string">
      <![CDATA[
        SELECT 
         t2.value
        FROM Dictionary t2
        WHERE t2.id IN 
        (
          SELECT t1.ParentId FROM Dictionary t1 WHERE t1.value = #value#
        )
      ]]>
    </select>

    <select id="GetDictionaryByModel" parameterClass="Dictionary" resultClass="Dictionary">
      <![CDATA[
        select 
          a.Id        AS "Id"
          ,a.Key      AS "Key"
          ,a.Value    AS "Value"
          ,a.Sort     AS "Sort"
          ,a.Status   AS "Status"
          ,a.Remark   AS "Remark"
          ,a.ParentId AS "ParentId"
        from dictionary_config a 
      ]]>
      <dynamic prepend="where">
        <isNotNull property="ParentId" prepend="and">
          <![CDATA[
             a.ParentId=#ParentId#
          ]]>
        </isNotNull>
        <isNotNull prepend="and" property="Key">
          <![CDATA[
            a.Key=#Key#
          ]]>
        </isNotNull>
        <isNotNull prepend="and" property="Value">
          <![CDATA[
            a.Value=#Value#
          ]]>
        </isNotNull>
      </dynamic>
      
    </select>

    <select id="GetDictionaryById" parameterClass="string" resultClass="Dictionary">
      <![CDATA[
        SELECT 
          a.Id        AS "Id"
          ,a.Key      AS "Key"
          ,a.Value    AS "Value"
          ,a.Sort     AS "Sort"
          ,a.Status   AS "Status"
          ,a.Remark   AS "Remark"
          ,a.ParentId AS "ParentId"
        FROM Dictionary a
        WHERE a.Id=#value#
      ]]>
    </select>
  </statements>
</sqlMap>