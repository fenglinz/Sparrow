<?xml version="1.0" encoding="utf-8" ?>
<CommandTexts xmlns="http://www.Mercurius.com/CommandText.xsd">

  <!-- 获取数据库信息 -->
  <CommandText name="GetDatabasesByMSSQL" commandType="Text">
    <![CDATA[
      Select * FROM SysDatabases ORDER BY dbid
    ]]>
  </CommandText>

  <CommandText name="GetDatabasesByPostgreSQL" commandType="Text">
    <![CDATA[
      select datname from pg_database where datistemplate=false
    ]]>
  </CommandText>

  <!-- 获取表的信息 -->
  <CommandText name="GetTableByMSSQL" commandType="Text">
    <![CDATA[
      WITH cte AS(
	      SELECT
	        SCHEMA_NAME(schema_id) AS [Schema],
          type,
          name,
          object_id
	      FROM sys.objects
	      WHERE type IN('U','V') AND Name<>'sysdiagrams'
      )
      SELECT
        cte.[Schema],
        cte.Name,
        CASE cte.type WHEN 'U' THEN 0 ELSE 1 END IsView,
        CASE WHEN a.value IS NULL THEN cte.name ELSE a.value END Comments
      FROM cte
      LEFT JOIN sys.extended_properties a
        ON cte.object_id=a.major_id AND a.minor_id=0
      WHERE cte.[Schema]=@schema AND cte.name=@table
    ]]>
  </CommandText>

  <CommandText name="GetTableByPostgreSQL" commandType="Text">
    <![CDATA[
      select
        a.relname AS "Name",
        0 as "IsView",
        a.schemaname AS "Schema",
        CASE
          WHEN b.description is null then a.relname
          else b.description
        end AS "Comments"
      from pg_stat_user_tables a
      left JOIN pg_description b
      on a.relid=b.objoid and objsubid=0
      where a.schemaname=:schema and a.relname=:table
    ]]>
  </CommandText>

  <!-- 修改表的注释信息 -->
  <CommandText name="CommentByMSSQL" commandType="Text">
    <![CDATA[
      IF ((SELECT count(*) from FN_LISTEXTENDEDPROPERTY('MS_Description',N'SCHEMA',@schema,@type,@table,NULL,DEFAULT))>0)
        EXEC sp_updateextendedproperty
          @name = N'MS_Description',
          @value = @comments,
          @level0type = 'SCHEMA',
          @level0name = @schema,
          @level1type = @type,
          @level1name = @table
      ELSE
        EXEC sp_addextendedproperty
          @name = N'MS_Description',
          @value = @comments,
          @level0type = N'SCHEMA',
          @level0name = @schema,
          @level1type = @type,
          @level1name = @table,
          @level2type = NULL,
          @level2name = NULL
    ]]>
  </CommandText>

  <CommandText name="CommentByPostgreSQL" commandType="Text">
    <![CDATA[
      COMMENT ON TABLE "{0}"."{1}" IS '{2}';
    ]]>
  </CommandText>

  <!-- 获取所有表的信息 -->
  <CommandText name="GetTablesByMSSQL" commandType="Text">
    <![CDATA[
      WITH cte AS(
	      SELECT
	        SCHEMA_NAME(schema_id) AS [Schema],
          type,
          name,
          object_id
	      FROM sys.objects
	      WHERE type IN('U','V') AND Name<>'sysdiagrams'
      )
      SELECT
        cte.[Schema],
        cte.Name,
        CASE cte.type WHEN 'U' THEN 0 ELSE 1 END IsView,
        CASE WHEN a.value IS NULL THEN cte.name ELSE a.value END Comments
      FROM cte
      LEFT JOIN sys.extended_properties a
        ON cte.object_id=a.major_id AND a.minor_id=0
      ORDER BY cte.[schema],cte.Name
    ]]>
  </CommandText>

  <CommandText name="GetTablesByPostgreSQL" commandType="Text">
    <![CDATA[
      select
        a.relname AS "Name",
        0 as "IsView",
        a.schemaname AS "Schema",
        CASE
          WHEN b.description is null then a.relname
          else b.description
        end AS "Comments"
      from pg_stat_user_tables a
      left JOIN pg_description b
       on a.relid=b.objoid and objsubid=0
      order by a.schemaname, a.relname
    ]]>
  </CommandText>

  <!-- 判断表是否存在 -->
  <CommandText name="IsTableExistsByMSSQL" commandType="Text">
    <![CDATA[
      SELECT COUNT(*) FROM sysobjects where NAME=@table AND (xtype='u' OR xtype='v') AND status>=0 AND Name!='sysdiagrams'
    ]]>
  </CommandText>

</CommandTexts>