<?xml version="1.0" encoding="utf-8" ?>
<CommandTexts xmlns="http://www.Mercurius.com/CommandText.xsd">

  <!-- 获取数据库字段信息。 -->
  <CommandText name="GetColumnsByMSSQL" commandType="Text">
    <![CDATA[
      SELECT
        a.name AS Name
        ,a.name AS PropertyName
        ,b.name AS DataType
        ,COLUMNPROPERTY(a.id, a.name, 'PRECISION') AS DataLength
        ,CASE WHEN EXISTS(
          SELECT 1 FROM sysobjects
          WHERE xtype= 'PK' and name in ( 
            SELECT
              name
            FROM sysindexes
            WHERE indid in(
              SELECT
                indid
              FROM sysindexkeys
              WHERE id = a.id AND colid=a.colid
            )
          )
        ) THEN 1 ELSE 0 END AS IsPrimaryKey
        ,a.IsNullable AS IsNullable
        ,COLUMNPROPERTY(a.id, a.name, 'IsIdentity') AS IsIdentity
        ,ISNULL(e.text, '') AS DataDefault
        ,CASE
          WHEN g.[value] IS NULL THEN a.Name
          ELSE g.[value]
        END AS Description
        ,a.colorder AS Sort
      FROM syscolumns a
      LEFT JOIN systypes b 
        ON a.xusertype=b.xusertype
      INNER JOIN sys.objects d 
        ON a.id=d.object_id AND (d.type='U' OR d.type='V') AND d.name<>'dtproperties'
      INNER JOIN sys.schemas s
        ON d.schema_id=s.schema_id
      LEFT JOIN syscomments e 
        ON a.cdefault=e.id
      LEFT JOIN sys.extended_properties g 
        ON a.id=g.major_id AND a.colid=g.minor_id
      WHERE s.name=@schema AND d.name=@table
      ORDER BY a.id, a.colorder
    ]]>
  </CommandText>

  <CommandText name="GetColumnsByPostgreSQL" commandType="Text">
    <![CDATA[
      select
        b.column_name AS "Name",
	      b.column_name AS "PropertyName",
        b.udt_name AS "DataType",
        CASE
          when b.udt_name='text' then 1073741824
					when b.udt_name LIKE 'timestamp%' then 30
					when b.udt_name='date' then 14
          when b.udt_name='time' then 10
					when b.numeric_precision is null THEN b.character_maximum_length
					ELSE b.numeric_precision
				END	AS "DataLength",
        case
          when d.column_name is not null then 1
          else 0
        end AS "IsPrimaryKey",
        CASE
          when b.is_nullable='NO' then 0
          else 1
        END AS "IsNullable",
        CASE
          when b.column_default like 'nextval(%::regclass)' then 1
          else 0
        END AS "IsIdentity",
        b.column_default AS "DataDefault",
        case
          when (c.description is null) or c.description='' then b.column_name
          else c.description
        end AS "Description",
        b.ordinal_position AS "Sort"
      from pg_stat_user_tables a 
      INNER JOIN information_schema.columns b
        on a.schemaname=b.table_schema and a.relname=b.table_name
      left JOIN pg_description c
        on a.relid=c.objoid and b.ordinal_position=c.objsubid
      LEFT JOIN information_schema.key_column_usage d
        ON b.table_schema=d.constraint_schema and b.table_name=d.table_name and b.column_name=d.column_name
      where b.table_schema=:schema and b.table_name=:table
    ]]>
  </CommandText>
  
  <!-- 修改字段注释 -->
  <CommandText name="CommentColumnByMSSQL" commandType="Text">
    <![CDATA[
      IF ((SELECT COUNT(*) from fn_listextendedproperty('MS_Description','SCHEMA', @schema,@type, @table,'COLUMN', @column)) > 0) 
        EXEC sp_updateextendedproperty
          @name = N'MS_Description',
          @value = @comments,
          @level0type = 'SCHEMA',
          @level0name = @schema,
          @level1type = @type,
          @level1name = @table,
          @level2type = 'COLUMN',
          @level2name = @column
        ELSE
          EXEC sp_addextendedproperty
            @name = N'MS_Description',
            @value = @comments,
            @level0type = 'SCHEMA',
            @level0name = @schema,
            @level1type = @type,
            @level1name = @table,
            @level2type = 'COLUMN',
            @level2name = @column
    ]]>
  </CommandText>

  <CommandText name="CommentColumnByPostgreSQL" commandType="Text">
    <![CDATA[
      COMMENT ON COLUMN "{0}"."{1}"."{2}" IS '{3}';
    ]]>
  </CommandText>
</CommandTexts>