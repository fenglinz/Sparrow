@{
    var rspLogLevel = this.ViewBag.LogLevel as Response<SystemSetting>;
    var productInfos = this.ViewBag.ProductInfos as ResponseSet<SystemSetting>;

    var logLevel = (rspLogLevel != null && rspLogLevel.Data != null && rspLogLevel.IsSuccess) ? rspLogLevel.Data.Value : "1";
    var productName = productInfos.Datas.IsEmpty() ? null : productInfos.Datas.FirstOrDefault(p => p.Name == "ProductName");
    var productVersion = productInfos.Datas.IsEmpty() ? null : productInfos.Datas.FirstOrDefault(p => p.Name == "ProductVersion");
}

@section Scripts
{
    <script type="text/javascript">
        function viewCache() {
            mercurius.OpenDialog('@Url.Action("ShowCaches")', 'ShowCaches', '显示所有缓存', 720, 500, { statusbar: false });
        }

        function clearCache() {
            confirm('是否确定清空缓存？', function () {
                $('#frmClearCache').submit();
            });
        }

        function saveLogLevel() {
            $.ajax({
                type: 'POST',
                cache: false,
                url: '@Url.Action("SaveSetting","SystemSetting", new {@Area="Admin"})',
                data: { name: 'LogLevel', value: $('#level').val() },
                dataType: 'json',
                success: function (rs) {
                    if (rs.IsSuccess) {
                        mercurius.ShowTipsMessage('修改成功！', 3000, 4);
                    } else {
                        alert('修改失败，失败原因：' + rs.ErrorMessage);
                    }
                }
            });
        }

        function EncryptOrDecrypt(type) {
            $.ajax({
                type: 'POST',
                cache: false,
                url: '@Url.Action("EncryptOrDecrypt","SystemSetting")',
                data: { type: type, source: $('#__source').val() },
                dataType: 'json',
                success: function (rs) {
                    $('#__target').html(rs);
                }
            });
        }

        function RefreshMachineKey() {
            $.ajax({
                type: 'POST',
                cache: false,
                url: '@Url.Action("RefreshMachineKey", "SystemSetting", new {@Area="Admin"})',
                dataType: 'json',
                success: function (rs) {
                    $('#ValidationKey').val(rs.ValidationKey);
                    $('#DecryptionKey').val(rs.DecryptionKey);
                }
            });
        }

        function ChangeMachineKey() {
            mercurius.ShowConfirmMessage('是否确定更换计算机密钥？', function () {
                mercurius.BeginLoading();
                $('#frmChangeMachineKey').submit();
            });
        }

        function SynchronizeMachineKey() {
            mercurius.ShowConfirmMessage('是否确定同步文件系统的的计算机密钥？', function () {
                mercurius.Ajax('@Url.Action("SynchronizeMachineKey", "SystemSetting")', { validationKey: $('#ValidationKey').val(), decryptionKey: $('#DecryptionKey').val() },function(rs) {
                    if (rs.IsSuccess) {
                        mercurius.ShowTipsMessage('同步成功！', 3000, 4);
                    } else {
                        mercurius.ShowTipsMessage('同步失败，请稍后再试！', 3000, 5);
                    }
                });
            });
        }
    </script>
}
<div class="header">系统设置</div>
<div class="panel panel-default" style="margin-top: 1px;">
    <div class="panel-heading">
        <b>设置日志记录级别</b>
    </div>
    <div class="panel-body">
        <div class="form-inline">
            <div class="form-group">
                <label class="control-label">
                    日志记录级别
                    <select class="form-control" id="level" style="width:200px;">
                        <option value="0" @(logLevel == "0" ? "selected" : string.Empty)>全部</option>
                        <option value="1" @(logLevel == "1" ? "selected" : string.Empty)>调试</option>
                        <option value="2" @(logLevel == "2" ? "selected" : string.Empty)>普通</option>
                        <option value="3" @(logLevel == "3" ? "selected" : string.Empty)>警告</option>
                        <option value="4" @(logLevel == "4" ? "selected" : string.Empty)>错误</option>
                        <option value="5" @(logLevel == "5" ? "selected" : string.Empty)>记录</option>
                    </select>
                </label>
            </div>
            <button type="button" class="btn btn-primary" onclick="saveLogLevel()">
                <i class="glyphicon glyphicon-floppy-saved"></i> 保存
            </button>
        </div>
    </div>
</div>

<div class="panel panel-default">
    <div class="panel-heading">
        <b>设置产品信息</b>
    </div>
    <div class="panel-body">
        @using (Ajax.BeginForm("SaveProductInfo", null, new AjaxOptions { HttpMethod = "POST" }, new { @class = "form-inline", @role = "form" }))
        {
            @Html.AntiForgeryToken()
            @Html.Hidden("productNameId", productName != null ? productName.Id : string.Empty)
            @Html.Hidden("productVersionId", productVersion != null ? productVersion.Id : string.Empty)
            <div class="form-group">
                <label class="control-label">
                    产品名称
                    <input name="productName" type="text" class="form-control" value="@(productName == null ? string.Empty : productName.Value)" style="width: 400px; display: inline-block;" />
                </label>
                <label class="control-label" style="margin-left: 15px;">
                    版本
                    <input name="productVersion" type="text" class="form-control" value="@(productVersion == null ? string.Empty : productVersion.Value)" style="width: 120px; display: inline-block" />
                </label>
                <button type="submit" class="btn btn-primary">
                    <i class="glyphicon glyphicon-floppy-saved"></i> 保存
                </button>
            </div>
        }
    </div>
</div>

<div class="panel panel-default">
    <div class="panel-heading">
        <b>缓存管理</b>
    </div>
    <div class="panel-body">
        @using (Ajax.BeginForm("ClearCache", "SystemSetting", null, new AjaxOptions { HttpMethod = "POST" }, new { @id = "frmClearCache", @class = "form-inline" }))
        {
            @Html.AntiForgeryToken()
            <div class="form-group">
                <a class="btn btn-primary" onclick="viewCache()">
                    <i class="glyphicon glyphicon-tasks"></i> 查看缓存
                </a>
                <button type="button" class="btn btn-danger" onclick="clearCache()">
                    <i class="glyphicon glyphicon-trash"></i> 清空缓存
                </button>
            </div>
        }
    </div>
</div>

<div class="panel panel-default">
    <div class="panel-heading">
        <b>加密/解密</b>
    </div>
    <div class="panel-body">
        <div class="form-horizontal">
            <div class="form-group">
                <label for="__source" class="control-label col-sm-1">字符串</label>
                <div class="col-sm-8">
                    <textarea id="__source" class="form-control" rows="3"></textarea>
                </div>
            </div>
            <div class="form-group">
                <label for="__target" class="control-label col-sm-1">结果</label>
                <div class="col-sm-8">
                    <div id="__target" class="form-control" readonly style="height: 75px; overflow-x: auto; word-break: break-all;"></div>
                </div>
            </div>
            <div class="form-group">
                <label class="control-label col-sm-1"></label>
                <div class="col-sm-8">
                    <div class="btn-group">
                        <button type="button" class="btn btn-primary" onclick="EncryptOrDecrypt('encrypt')">
                            <i class="glyphicon glyphicon-lock"></i> 加密
                        </button>
                        <button type="button" class="btn btn-success" onclick="EncryptOrDecrypt('decrypt')">
                            <i class="fa fa-key"></i> 解密
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="panel panel-default">
    <div class="panel-heading">
        <b>计算机密钥</b>
    </div>
    <div class="panel-body">
        @using (Ajax.BeginForm("ChangeMachineKey", "SystemSetting", null, new AjaxOptions { HttpMethod = "POST" }, new { @id = "frmChangeMachineKey", @class = "form-horizontal" }))
        {
            <div class="form-group">
                <label for="ValidationKey" class="control-label col-sm-1">验证密钥</label>
                <div class="col-sm-8">
                    <input type="text" id="ValidationKey" name="ValidationKey" class="form-control" value="@this.ViewBag.ValidationKey" readonly="readonly" />
                </div>
            </div>
            <div class="form-group">
                <label for="DecryptionKey" class="control-label col-sm-1">解密密钥</label>
                <div class="col-sm-4">
                    <input type="text" id="DecryptionKey" name="DecryptionKey" class="form-control" readonly="readonly" value="@this.ViewBag.DecryptionKey" />
                </div>
            </div>
            <div class="form-group">
                <label class="col-sm-1"></label>
                <div class="col-sm-6">
                    <div class="btn-group">
                        <button type="button" class="btn btn-primary" onclick="RefreshMachineKey();">
                            <i class="glyphicon glyphicon-refresh"></i> 刷新
                        </button>
                        <button type="button" class="btn btn-danger" onclick="ChangeMachineKey();">
                            <i class="glyphicon glyphicon-pencil"></i> 更新
                        </button>
                        <button type="button" class="btn btn-success" onclick="SynchronizeMachineKey();">
                            <i class="glyphicon glyphicon-transfer"></i> 同步文件系统密钥
                        </button>
                    </div>
                </div>
            </div>
        }
    </div>
</div>